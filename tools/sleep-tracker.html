<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free Sleep Tracker - Log your sleep, track patterns, and see trends. Calculate sleep efficiency, duration, and quality over time.">
    <meta name="keywords" content="sleep tracker, sleep diary, sleep log, sleep journal, sleep efficiency, sleep patterns, sleep quality tracker">
    <meta name="author" content="Spacire">
    <meta name="robots" content="index, follow">
    
    <title>Sleep Tracker - Free Sleep Diary & Log | Spacire</title>
    
    <link rel="canonical" href="https://tools.spacire.com/sleep-tracker">
    
    <meta property="og:title" content="Sleep Tracker - Log Your Sleep & See Trends">
    <meta property="og:description" content="Free sleep diary to track your sleep patterns, quality, and habits over time.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tools.spacire.com/sleep-tracker">
    <meta property="og:site_name" content="Spacire Sleep Tools">
    
    <link rel="icon" type="image/png" href="images/favicon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- html2pdf.js for rich PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Sleep Tracker",
        "description": "Track your sleep patterns, quality, and habits. View trends and get insights to improve your sleep.",
        "url": "https://tools.spacire.com/sleep-tracker",
        "applicationCategory": "HealthApplication",
        "operatingSystem": "Web Browser",
        "offers": {"@type": "Offer", "price": "0", "priceCurrency": "GBP"},
        "publisher": {"@type": "Organization", "name": "Spacire", "url": "https://spacire.com"}
    }
    </script>
    
    <style>
        :root {
            --primary: #042548;
            --primary-light: #0a3a6b;
            --accent: #E0B252;
            --accent-light: #f5e6c4;
            --text-primary: #1a1a1a;
            --text-secondary: #555;
            --text-light: #777;
            --text-muted: #888;
            --bg: #ffffff;
            --bg-light: #f8f9fa;
            --hover: #f8f9fa;
            --border: #e0e0e0;
            --success: #d4edda;
            --success-dark: #28a745;
            --warning: #fff3cd;
            --warning-dark: #ffc107;
            --error: #f8d7da;
            --error-dark: #dc3545;
            --info: #d1ecf1;
            --info-dark: #17a2b8;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.2s ease;
            --font-primary: 'Domine', Georgia, serif;
        }
        
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: var(--font-primary); background: #f5f5f5; color: var(--text-primary); line-height: 1.6; }
        
        /* Header */
        .site-header { background: var(--primary); padding: 16px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo-link { text-decoration: none; }
        .logo-text { font-size: 22px; font-weight: 700; color: #fff; letter-spacing: 0.02em; }
        .header-nav { display: flex; gap: 28px; }
        .header-nav a { color: rgba(255,255,255,0.85); text-decoration: none; font-size: 14px; font-weight: 500; transition: var(--transition); }
        .header-nav a:hover { color: var(--accent); }
        .mobile-menu-btn { display: none; background: none; border: none; cursor: pointer; padding: 8px; flex-direction: column; gap: 5px; }
        .mobile-menu-btn span { display: block; width: 24px; height: 2px; background: #fff; transition: var(--transition); }
        .mobile-nav { display: none; background: var(--primary); padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .mobile-nav.active { display: block; }
        .mobile-nav a { display: block; color: rgba(255,255,255,0.85); text-decoration: none; padding: 12px 0; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .mobile-nav a:last-child { border-bottom: none; }
        @media (max-width: 768px) { .header-nav { display: none; } .mobile-menu-btn { display: flex; } }
        
        /* Breadcrumb */
        .breadcrumb { background: var(--hover); padding: 12px 0; border-bottom: 1px solid var(--border); }
        .breadcrumb-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; font-size: 13px; }
        .breadcrumb a { color: var(--primary); text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb span { color: var(--text-muted); margin: 0 8px; }
        
        /* Main Container */
        .main-container { max-width: 1000px; margin: 0 auto; padding: 40px 20px 60px; }
        .page-title { text-align: center; margin-bottom: 32px; }
        .page-title h1 { font-size: 28px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
        .page-subtitle { font-size: 16px; color: var(--text-secondary); max-width: 600px; margin: 0 auto; }
        
        /* Tabs */
        .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 24px; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition); color: var(--text-secondary); }
        .tab-btn:hover { border-color: var(--primary); color: var(--primary); }
        .tab-btn.active { background: var(--primary); border-color: var(--primary); color: #fff; }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Card */
        .card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-md); margin-bottom: 24px; }
        .card-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: #fff; padding: 20px 24px; }
        .card-header h2 { font-size: 18px; font-weight: 600; margin: 0; }
        .card-header p { font-size: 13px; opacity: 0.9; margin: 4px 0 0; }
        .card-body { padding: 24px; }
        
        /* Form Elements */
        .form-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .form-sublabel { font-size: 12px; color: var(--text-secondary); font-weight: 400; display: block; margin-top: 2px; }
        .form-input, .form-select { width: 100%; padding: 12px 14px; border: 2px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 14px; transition: var(--transition); }
        .form-input:focus, .form-select:focus { outline: none; border-color: var(--primary); }
        
        /* Date Picker */
        .date-nav { display: flex; align-items: center; gap: 16px; margin-bottom: 24px; }
        .date-nav-btn { width: 40px; height: 40px; border: 2px solid var(--border); border-radius: var(--radius-md); background: var(--bg); cursor: pointer; font-size: 18px; transition: var(--transition); }
        .date-nav-btn:hover { border-color: var(--primary); background: var(--hover); }
        .current-date { font-size: 18px; font-weight: 600; color: var(--primary); flex: 1; text-align: center; }
        .today-btn { padding: 8px 16px; background: var(--accent); color: var(--primary); border: none; border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 13px; font-weight: 600; cursor: pointer; transition: var(--transition); }
        .today-btn:hover { background: #c9a047; }
        
        /* Quality Rating */
        .quality-rating { display: flex; gap: 8px; flex-wrap: wrap; }
        .quality-btn { padding: 10px 16px; background: var(--bg-light); border: 2px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 13px; cursor: pointer; transition: var(--transition); }
        .quality-btn:hover { border-color: var(--primary); }
        .quality-btn.selected { border-color: var(--primary); background: var(--primary); color: #fff; }
        
        /* Factor Toggles */
        .factors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }
        .factor-toggle { display: flex; align-items: center; gap: 8px; padding: 10px 12px; background: var(--bg-light); border: 2px solid var(--border); border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); }
        .factor-toggle:hover { border-color: var(--primary); }
        .factor-toggle.active { border-color: var(--primary); background: #e8f4fc; }
        .factor-toggle input { display: none; }
        .factor-icon { font-size: 16px; }
        .factor-label { font-size: 12px; color: var(--text-primary); }
        
        /* Button */
        .btn { padding: 14px 28px; border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 15px; font-weight: 600; cursor: pointer; transition: var(--transition); border: none; }
        .btn-primary { background: var(--accent); color: var(--primary); width: 100%; }
        .btn-primary:hover { background: #c9a047; transform: translateY(-1px); }
        .btn-secondary { background: var(--bg-light); color: var(--primary); border: 2px solid var(--border); }
        .btn-secondary:hover { border-color: var(--primary); }
        .btn-danger { background: var(--error); color: var(--error-dark); }
        .btn-danger:hover { background: #f5c6cb; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        
        /* Stats Cards */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; text-align: center; }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .stat-card.highlight { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); }
        .stat-card.highlight .stat-value, .stat-card.highlight .stat-label { color: #fff; }
        
        /* Chart */
        .chart-container { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; }
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px; }
        .chart-title { font-size: 16px; font-weight: 600; color: var(--primary); }
        .chart-range { display: flex; gap: 8px; }
        .range-btn { padding: 6px 14px; background: var(--bg-light); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 12px; cursor: pointer; transition: var(--transition); }
        .range-btn:hover { border-color: var(--primary); }
        .range-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); }
        .chart-canvas { width: 100%; height: 200px; }
        .chart-legend { display: flex; gap: 20px; justify-content: center; margin-top: 16px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
        .legend-color { width: 12px; height: 12px; border-radius: 2px; }
        
        /* History Table */
        .history-table { width: 100%; border-collapse: collapse; }
        .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
        .history-table th { background: var(--bg-light); font-weight: 600; color: var(--primary); }
        .history-table tr:hover { background: var(--hover); }
        .history-table .quality-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .quality-excellent { background: #d4edda; color: #155724; }
        .quality-good { background: #cce5ff; color: #004085; }
        .quality-fair { background: #fff3cd; color: #856404; }
        .quality-poor { background: #f8d7da; color: #721c24; }
        .quality-terrible { background: #d6d6d6; color: #333; }
        .delete-btn { background: none; border: none; color: var(--error-dark); cursor: pointer; font-size: 16px; padding: 4px; }
        .delete-btn:hover { color: #a71d2a; }
        .no-data { text-align: center; padding: 40px; color: var(--text-muted); }
        
        /* Weekly Summary */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .summary-card { background: var(--bg-light); border-radius: var(--radius-md); padding: 20px; }
        .summary-card-title { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 12px; }
        .summary-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .summary-item:last-child { border-bottom: none; }
        .summary-item-label { color: var(--text-secondary); }
        .summary-item-value { font-weight: 600; color: var(--primary); }
        
        /* Insights */
        .insight-card { background: var(--info); border-left: 4px solid var(--info-dark); border-radius: 0 var(--radius-md) var(--radius-md) 0; padding: 16px; margin-bottom: 12px; }
        .insight-title { font-size: 14px; font-weight: 600; color: #0c5460; margin-bottom: 4px; }
        .insight-text { font-size: 13px; color: #0c5460; margin: 0; }
        
        /* Export Section */
        .export-section { background: var(--bg-light); border-radius: var(--radius-md); padding: 20px; margin-top: 24px; }
        .export-title { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 12px; }
        .export-buttons { display: flex; gap: 12px; flex-wrap: wrap; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .empty-title { font-size: 18px; font-weight: 600; color: var(--primary); margin-bottom: 8px; }
        .empty-text { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
        
        /* Toast */
        .toast { position: fixed; bottom: 20px; right: 20px; background: var(--primary); color: #fff; padding: 16px 24px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: var(--success-dark); }
        .toast.error { background: var(--error-dark); }
        
        /* Info Section */
        .info-section { margin-top: 40px; }
        .info-toggle { background: #fff; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 12px; overflow: hidden; }
        .toggle-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 24px; cursor: pointer; transition: var(--transition); }
        .toggle-header:hover { background: var(--hover); }
        .toggle-title { font-size: 15px; font-weight: 600; color: var(--primary); }
        .toggle-icon { font-size: 20px; color: var(--primary); transition: transform 0.3s ease; }
        .info-toggle.open .toggle-icon { transform: rotate(180deg); }
        .info-content { display: none; padding: 24px; background: #fff; border-top: 1px solid var(--border); }
        .info-content.open { display: block; }
        .info-content p { font-size: 14px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 12px; }
        .info-content ul { margin: 0 0 16px 0; padding-left: 20px; }
        .info-content li { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 6px; }
        .tools-grid-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px; }
        .tool-link-card { display: block; padding: 16px; background: var(--hover); border: 1px solid var(--border); border-radius: var(--radius-md); text-decoration: none; transition: var(--transition); }
        .tool-link-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .tool-link-card h5 { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 4px; }
        .tool-link-card p { font-size: 12px; color: var(--text-secondary); margin: 0; }
        
        /* Report Tab Specific */
        .report-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
        .report-option { background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius-lg); padding: 24px; text-align: center; transition: var(--transition); }
        .report-option:hover { border-color: var(--primary); box-shadow: var(--shadow-md); }
        .report-icon { font-size: 48px; margin-bottom: 16px; }
        .report-option h3 { font-size: 16px; font-weight: 600; color: var(--primary); margin-bottom: 8px; }
        .report-option p { font-size: 13px; color: var(--text-secondary); margin-bottom: 16px; line-height: 1.5; }
        .report-badge { display: inline-block; background: var(--success); color: var(--success-dark); padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600; margin-bottom: 12px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-overlay.active { display: flex; }
        .modal { background: #fff; border-radius: var(--radius-lg); max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
        .modal-header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: #fff; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { margin: 0; font-size: 18px; }
        .modal-close { background: none; border: none; color: #fff; font-size: 24px; cursor: pointer; padding: 0; line-height: 1; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border); display: flex; gap: 12px; justify-content: flex-end; }
        
        /* Checkbox */
        .checkbox-group { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 16px; }
        .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; margin-top: 2px; accent-color: var(--primary); cursor: pointer; }
        .checkbox-label { font-size: 13px; color: var(--text-secondary); line-height: 1.5; cursor: pointer; }
        .checkbox-label a { color: var(--primary); }
        
        /* Loading Spinner */
        .spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Report Preview Notice */
        .report-notice { background: var(--accent-light); border: 1px solid var(--accent); border-radius: var(--radius-md); padding: 16px; margin-bottom: 20px; }
        .report-notice p { margin: 0; font-size: 13px; color: var(--text-primary); }
        .report-notice strong { color: var(--primary); }
        
        /* Footer */
        .site-footer { background: var(--primary); color: #fff; padding: 48px 0 24px; margin-top: 60px; }
        .footer-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-section h4 { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 16px; color: var(--accent); }
        .footer-section a { display: block; color: rgba(255,255,255,0.8); text-decoration: none; font-size: 14px; margin-bottom: 10px; transition: var(--transition); }
        .footer-section a:hover { color: var(--accent); }
        .footer-bottom { padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; font-size: 12px; color: rgba(255,255,255,0.6); }
        .footer-legal { margin-top: 12px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .footer-legal a { color: rgba(255,255,255,0.6); text-decoration: none; }
        .footer-legal a:hover { color: var(--accent); }
        
        @media (max-width: 600px) {
            .form-row { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .history-table { font-size: 12px; }
            .history-table th, .history-table td { padding: 8px 6px; }
            .tabs { gap: 6px; }
            .tab-btn { padding: 10px 14px; font-size: 12px; }
        }
        
        /* PDF Report Styles (hidden, used for generation) */
        #pdfReportContainer { position: absolute; left: -9999px; top: 0; width: 210mm; background: #fff; }
        .pdf-report { padding: 20px; font-family: 'Domine', Georgia, serif; font-size: 11px; color: #1a1a1a; }
        .pdf-header { text-align: center; padding-bottom: 15px; border-bottom: 3px solid #042548; margin-bottom: 20px; }
        .pdf-logo { font-size: 24px; font-weight: 700; color: #042548; letter-spacing: 0.02em; }
        .pdf-title { font-size: 18px; color: #042548; margin: 10px 0 5px; }
        .pdf-subtitle { font-size: 12px; color: #555; }
        .pdf-section { margin-bottom: 20px; }
        .pdf-section-title { font-size: 14px; font-weight: 600; color: #042548; border-bottom: 2px solid #E0B252; padding-bottom: 5px; margin-bottom: 12px; }
        .pdf-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 15px; }
        .pdf-stat-box { background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 6px; padding: 12px; text-align: center; }
        .pdf-stat-value { font-size: 20px; font-weight: 700; color: #042548; }
        .pdf-stat-label { font-size: 10px; color: #555; margin-top: 4px; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        .pdf-table th, .pdf-table td { padding: 8px 10px; text-align: left; border-bottom: 1px solid #e0e0e0; font-size: 10px; }
        .pdf-table th { background: #042548; color: #fff; font-weight: 600; }
        .pdf-table tr:nth-child(even) { background: #f8f9fa; }
        .pdf-insights { background: #d1ecf1; border-left: 4px solid #17a2b8; padding: 12px; margin-bottom: 15px; border-radius: 0 6px 6px 0; }
        .pdf-insight-title { font-weight: 600; color: #0c5460; margin-bottom: 4px; }
        .pdf-insight-text { color: #0c5460; margin: 0; }
        .pdf-disclaimer { background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 12px; margin-top: 20px; font-size: 10px; color: #856404; }
        .pdf-disclaimer-title { font-weight: 600; margin-bottom: 5px; }
        .pdf-footer { text-align: center; margin-top: 20px; padding-top: 15px; border-top: 1px solid #e0e0e0; font-size: 10px; color: #777; }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <a href="https://tools.spacire.com" class="logo-link">
                <span class="logo-text">Spacire</span>
            </a>
            <nav class="header-nav">
                <a href="https://tools.spacire.com">All Tools</a>
                <a href="https://spacire.com/collections/sleep-aids-for-better-rest">Sleep Products</a>
                <a href="https://spacire.com/blogs/journal">Sleep Journal</a>
                <a href="https://spacire.com">Shop</a>
            </nav>
            <button class="mobile-menu-btn" aria-label="Toggle menu" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <nav class="mobile-nav" id="mobileNav">
            <a href="https://tools.spacire.com">All Tools</a>
            <a href="https://spacire.com/collections/sleep-aids-for-better-rest">Sleep Products</a>
            <a href="https://spacire.com/blogs/journal">Sleep Journal</a>
            <a href="https://spacire.com">Shop</a>
        </nav>
    </header>
    
    <!-- Breadcrumb -->
    <nav class="breadcrumb" aria-label="Breadcrumb">
        <div class="breadcrumb-content">
            <a href="https://spacire.com">Spacire</a>
            <span>&gt;</span>
            <a href="https://tools.spacire.com">Sleep Tools</a>
            <span>&gt;</span>
            <span style="color: var(--text-primary);">Sleep Tracker</span>
        </div>
    </nav>
    
    <main class="main-container">
        <header class="page-title">
            <h1>Sleep Tracker</h1>
            <p class="page-subtitle">Log your sleep, track patterns, and discover insights to improve your rest. Your data stays private in your browser.</p>
        </header>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('log')">Log Sleep</button>
            <button class="tab-btn" onclick="switchTab('trends')">Trends</button>
            <button class="tab-btn" onclick="switchTab('history')">History</button>
            <button class="tab-btn" onclick="switchTab('insights')">Insights</button>
            <button class="tab-btn" onclick="switchTab('reports')">Reports</button>
        </div>
        
        <!-- Log Tab -->
        <div class="tab-content active" id="logTab">
            <div class="card">
                <div class="card-header">
                    <h2>Log Your Sleep</h2>
                    <p>Record last night's sleep to track your patterns</p>
                </div>
                <div class="card-body">
                    <!-- Date Navigation -->
                    <div class="date-nav">
                        <button class="date-nav-btn" onclick="changeDate(-1)">&larr;</button>
                        <div class="current-date" id="currentDate">Today</div>
                        <button class="date-nav-btn" onclick="changeDate(1)">&rarr;</button>
                        <button class="today-btn" onclick="goToToday()">Today</button>
                    </div>
                    
                    <!-- Sleep Times -->
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Bedtime
                                <span class="form-sublabel">When did you get into bed?</span>
                            </label>
                            <input type="time" class="form-input" id="bedtime" value="22:30">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Time to Fall Asleep
                                <span class="form-sublabel">How long to fall asleep?</span>
                            </label>
                            <select class="form-select" id="latency">
                                <option value="5">About 5 minutes</option>
                                <option value="10">About 10 minutes</option>
                                <option value="15" selected>About 15 minutes</option>
                                <option value="20">About 20 minutes</option>
                                <option value="30">About 30 minutes</option>
                                <option value="45">About 45 minutes</option>
                                <option value="60">About 1 hour</option>
                                <option value="90">More than 1 hour</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">
                                Wake Time
                                <span class="form-sublabel">When did you wake up?</span>
                            </label>
                            <input type="time" class="form-input" id="wakeTime" value="07:00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                Time Awake at Night
                                <span class="form-sublabel">Total time awake during night</span>
                            </label>
                            <select class="form-select" id="waso">
                                <option value="0" selected>None / Don't remember</option>
                                <option value="5">About 5 minutes</option>
                                <option value="10">About 10 minutes</option>
                                <option value="15">About 15 minutes</option>
                                <option value="30">About 30 minutes</option>
                                <option value="45">About 45 minutes</option>
                                <option value="60">About 1 hour</option>
                                <option value="90">More than 1 hour</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Sleep Quality -->
                    <div class="form-group">
                        <label class="form-label">How would you rate your sleep quality?</label>
                        <div class="quality-rating" id="qualityRating">
                            <button class="quality-btn" onclick="selectQuality(1, this)">1 - Terrible</button>
                            <button class="quality-btn" onclick="selectQuality(2, this)">2 - Poor</button>
                            <button class="quality-btn" onclick="selectQuality(3, this)">3 - Fair</button>
                            <button class="quality-btn" onclick="selectQuality(4, this)">4 - Good</button>
                            <button class="quality-btn" onclick="selectQuality(5, this)">5 - Excellent</button>
                        </div>
                    </div>
                    
                    <!-- Factors -->
                    <div class="form-group">
                        <label class="form-label">Factors that may have affected your sleep</label>
                        <div class="factors-grid">
                            <label class="factor-toggle" onclick="toggleFactor(this)">
                                <input type="checkbox" value="caffeine">
                                <span class="factor-icon">&#9749;</span>
                                <span class="factor-label">Caffeine</span>
                            </label>
                            <label class="factor-toggle" onclick="toggleFactor(this)">
                                <input type="checkbox" value="alcohol">
                                <span class="factor-icon">&#127863;</span>
                                <span class="factor-label">Alcohol</span>
                            </label>
                            <label class="factor-toggle" onclick="toggleFactor(this)">
                                <input type="checkbox" value="exercise">
                                <span class="factor-icon">&#127939;</span>
                                <span class="factor-label">Exercise</span>
                            </label>
                            <label class="factor-toggle" onclick="toggleFactor(this)">
                                <input type="checkbox" value="stress">
                                <span class="factor-icon">&#128556;</span>
                                <span class="factor-label">Stress</span>
                            </label>
                            <label class="factor-toggle" onclick="toggleFactor(this)">
                                <input type="checkbox" value="screens">
                                <span class="factor-icon">&#128241;</span>
                                <span class="factor-label">Late Screens</span>
                            </label>
                            <label class="factor-toggle" onclick="toggleFactor(this)">
                                <input type="checkbox" value="lateMeal">
                                <span class="factor-icon">&#127829;</span>
                                <span class="factor-label">Late Meal</span>
                            </label>
                            <label class="factor-toggle" onclick="toggleFactor(this)">
                                <input type="checkbox" value="nap">
                                <span class="factor-icon">&#128164;</span>
                                <span class="factor-label">Napped</span>
                            </label>
                            <label class="factor-toggle" onclick="toggleFactor(this)">
                                <input type="checkbox" value="noise">
                                <span class="factor-icon">&#128266;</span>
                                <span class="factor-label">Noise</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Notes -->
                    <div class="form-group">
                        <label class="form-label">Notes (optional)</label>
                        <textarea class="form-input" id="notes" rows="2" placeholder="Any additional notes about your sleep..."></textarea>
                    </div>
                    
                    <button class="btn btn-primary" onclick="saveSleepEntry()">Save Sleep Entry</button>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="stats-grid" id="quickStats">
                <div class="stat-card">
                    <div class="stat-value" id="statEntries">0</div>
                    <div class="stat-label">Total Entries</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvgDuration">--</div>
                    <div class="stat-label">Avg Duration</div>
                </div>
                <div class="stat-card highlight">
                    <div class="stat-value" id="statAvgEfficiency">--%</div>
                    <div class="stat-label">Avg Efficiency</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statAvgQuality">--</div>
                    <div class="stat-label">Avg Quality</div>
                </div>
            </div>
        </div>
        
        <!-- Trends Tab -->
        <div class="tab-content" id="trendsTab">
            <!-- Duration Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Sleep Duration</div>
                    <div class="chart-range">
                        <button class="range-btn active" onclick="setRange(7, this)">7 Days</button>
                        <button class="range-btn" onclick="setRange(14, this)">14 Days</button>
                        <button class="range-btn" onclick="setRange(30, this)">30 Days</button>
                    </div>
                </div>
                <canvas id="durationChart" class="chart-canvas"></canvas>
                <div class="chart-legend">
                    <div class="legend-item"><div class="legend-color" style="background: #042548;"></div> Sleep Duration</div>
                    <div class="legend-item"><div class="legend-color" style="background: #28a745; opacity: 0.3;"></div> Target (7-9h)</div>
                </div>
            </div>
            
            <!-- Efficiency Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Sleep Efficiency</div>
                </div>
                <canvas id="efficiencyChart" class="chart-canvas"></canvas>
                <div class="chart-legend">
                    <div class="legend-item"><div class="legend-color" style="background: #E0B252;"></div> Efficiency %</div>
                    <div class="legend-item"><div class="legend-color" style="background: #28a745; opacity: 0.3;"></div> Good (85%+)</div>
                </div>
            </div>
            
            <!-- Quality Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <div class="chart-title">Sleep Quality Rating</div>
                </div>
                <canvas id="qualityChart" class="chart-canvas"></canvas>
            </div>
        </div>
        
        <!-- History Tab -->
        <div class="tab-content" id="historyTab">
            <div class="card">
                <div class="card-header">
                    <h2>Sleep History</h2>
                    <p>All your logged sleep entries</p>
                </div>
                <div class="card-body">
                    <div id="historyContent">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <div class="export-section">
                <div class="export-title">Export Your Data</div>
                <div class="export-buttons">
                    <button class="btn btn-secondary" onclick="exportCSV()">Download CSV</button>
                    <button class="btn btn-secondary" onclick="copyData()">Copy to Clipboard</button>
                    <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                </div>
            </div>
        </div>
        
        <!-- Insights Tab -->
        <div class="tab-content" id="insightsTab">
            <div class="card">
                <div class="card-header">
                    <h2>Weekly Summary</h2>
                    <p>Your sleep patterns from the last 7 days</p>
                </div>
                <div class="card-body">
                    <div class="summary-grid" id="weeklySummary">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>Sleep Insights</h2>
                    <p>Personalized observations based on your data</p>
                </div>
                <div class="card-body" id="insightsContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>
        
        <!-- Reports Tab (NEW) -->
        <div class="tab-content" id="reportsTab">
            <div class="card">
                <div class="card-header">
                    <h2>Sleep Reports</h2>
                    <p>Generate professional reports to share with your doctor or keep for your records</p>
                </div>
                <div class="card-body">
                    <div class="report-notice">
                        <p><strong>Tip:</strong> For the most useful report, log your sleep for at least 7 consecutive days. This gives healthcare providers enough data to identify patterns and make recommendations.</p>
                    </div>
                    
                    <div class="report-options">
                        <div class="report-option">
                            <div class="report-icon">&#128196;</div>
                            <div class="report-badge">Free</div>
                            <h3>Sleep Report for Doctor</h3>
                            <p>A comprehensive PDF report with your sleep data, patterns, and metrics formatted for healthcare providers. Includes 30-day summary, daily entries, and factor analysis.</p>
                            <button class="btn btn-primary" onclick="openReportModal('doctor')" id="doctorReportBtn">Generate PDF Report</button>
                        </div>
                        
                        <div class="report-option">
                            <div class="report-icon">&#128231;</div>
                            <div class="report-badge">Free</div>
                            <h3>Email My Report</h3>
                            <p>Get your sleep report delivered directly to your inbox. Perfect for keeping a record, sharing with family, or forwarding to your healthcare provider.</p>
                            <button class="btn btn-primary" onclick="openReportModal('email')" id="emailReportBtn">Email Report to Me</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2>What's Included in Your Report</h2>
                </div>
                <div class="card-body">
                    <div class="summary-grid">
                        <div class="summary-card">
                            <div class="summary-card-title">Summary Statistics</div>
                            <div class="summary-item"><span class="summary-item-label">Average sleep duration</span></div>
                            <div class="summary-item"><span class="summary-item-label">Sleep efficiency percentage</span></div>
                            <div class="summary-item"><span class="summary-item-label">Average sleep quality</span></div>
                            <div class="summary-item"><span class="summary-item-label">Sleep latency (time to fall asleep)</span></div>
                        </div>
                        <div class="summary-card">
                            <div class="summary-card-title">Detailed Data</div>
                            <div class="summary-item"><span class="summary-item-label">Daily sleep entries</span></div>
                            <div class="summary-item"><span class="summary-item-label">Bedtime and wake patterns</span></div>
                            <div class="summary-item"><span class="summary-item-label">Factor analysis (caffeine, stress, etc.)</span></div>
                            <div class="summary-item"><span class="summary-item-label">Personalized insights</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Info Section -->
        <section class="info-section">
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">How to Use This Tracker</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <p>Log your sleep each morning for the best results. Here's what each field means:</p>
                    <ul>
                        <li><strong>Bedtime:</strong> When you got into bed with the intention to sleep</li>
                        <li><strong>Time to Fall Asleep:</strong> Sleep latency - how long it took to fall asleep</li>
                        <li><strong>Wake Time:</strong> When you woke up for the day</li>
                        <li><strong>Time Awake at Night:</strong> WASO (Wake After Sleep Onset) - total time spent awake during the night</li>
                        <li><strong>Quality:</strong> Your subjective rating of how restorative your sleep felt</li>
                        <li><strong>Factors:</strong> Things that may have affected your sleep</li>
                    </ul>
                    <p>Your data is stored locally in your browser. It won't sync across devices, but it's completely private.</p>
                </div>
            </div>
            
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">Understanding Sleep Metrics</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <p><strong>Sleep Duration:</strong> Total time actually asleep. Calculated as time in bed minus latency and WASO. Adults should aim for 7-9 hours.</p>
                    <p><strong>Sleep Efficiency:</strong> Percentage of time in bed actually spent sleeping. A healthy efficiency is 85% or higher. Low efficiency often indicates insomnia or sleep disruption.</p>
                    <p><strong>Sleep Latency:</strong> Time to fall asleep. 10-20 minutes is normal. Falling asleep instantly may indicate sleep deprivation; taking over 30 minutes may indicate insomnia.</p>
                    <p><strong>WASO (Wake After Sleep Onset):</strong> Time spent awake after initially falling asleep. Some brief awakenings are normal, but frequent or long awakenings reduce sleep quality.</p>
                </div>
            </div>
            
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">More Sleep Tools</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <p>Complement your sleep tracking with these tools:</p>
                    <div class="tools-grid-info">
                        <a href="https://tools.spacire.com/sleep-quality-assessment" class="tool-link-card">
                            <h5>Sleep Quality Assessment</h5>
                            <p>7-dimension sleep analysis</p>
                        </a>
                        <a href="https://tools.spacire.com/sleep-calculator" class="tool-link-card">
                            <h5>Sleep Calculator</h5>
                            <p>Find ideal bedtime by age</p>
                        </a>
                        <a href="https://tools.spacire.com/chronotype-quiz" class="tool-link-card">
                            <h5>Chronotype Quiz</h5>
                            <p>Discover your sleep type</p>
                        </a>
                        <a href="https://tools.spacire.com/caffeine-sleep-calculator" class="tool-link-card">
                            <h5>Caffeine Calculator</h5>
                            <p>Optimize coffee timing</p>
                        </a>
                    </div>
                    <p style="margin-top: 20px; text-align: center;"><a href="https://tools.spacire.com" style="color: var(--primary); font-weight: 600;">View All Tools</a></p>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Email Modal -->
    <div class="modal-overlay" id="reportModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="modalTitle">Get Your Sleep Report</h3>
                <button class="modal-close" onclick="closeReportModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modalDescription" style="margin-bottom: 20px; color: var(--text-secondary); font-size: 14px;">Enter your email to receive your personalized sleep report.</p>
                
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="reportEmail" placeholder="your@email.com">
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="marketingConsent">
                    <label class="checkbox-label" for="marketingConsent">
                        I agree to receive occasional helpful sleep tips and product recommendations from Spacire. We never share your personal information with third parties. You can unsubscribe at any time.
                    </label>
                </div>
                
                <div class="checkbox-group">
                    <input type="checkbox" id="privacyConsent" required>
                    <label class="checkbox-label" for="privacyConsent">
                        I agree to the <a href="https://spacire.com/policies/privacy-policy" target="_blank">Privacy Policy</a> and understand my sleep data will be used to generate this report.
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeReportModal()">Cancel</button>
                <button class="btn btn-primary" id="modalSubmitBtn" onclick="submitReport()" style="width: auto;">
                    <span id="submitBtnText">Send Report</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div class="toast" id="toast"></div>
    
    <!-- Hidden PDF Report Container -->
    <div id="pdfReportContainer"></div>
    
    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>Sleep Tools</h4>
                    <a href="https://tools.spacire.com/sleep-tracker">Sleep Tracker</a>
                    <a href="https://tools.spacire.com/sleep-quality-assessment">Sleep Quality Assessment</a>
                    <a href="https://tools.spacire.com/chronotype-quiz">Chronotype Quiz</a>
                    <a href="https://tools.spacire.com/insomnia-quiz">Insomnia Quiz</a>
                    <a href="https://tools.spacire.com/sleep-calculator">Sleep Calculator</a>
                </div>
                <div class="footer-section">
                    <h4>Shop</h4>
                    <a href="https://spacire.com/collections/sleep-masks">Sleep Masks</a>
                    <a href="https://spacire.com/collections/white-noise-machines">White Noise Machines</a>
                    <a href="https://spacire.com/collections/blackout-curtains">Blackout Curtains</a>
                    <a href="https://spacire.com/collections/pillow-sleep-sprays">Sleep Sprays</a>
                </div>
                <div class="footer-section">
                    <h4>Company</h4>
                    <a href="https://spacire.com/pages/about-us">About Us</a>
                    <a href="https://spacire.com/pages/contact">Contact</a>
                    <a href="https://spacire.com/pages/faqs">FAQs</a>
                    <a href="https://spacire.com/blogs/journal">Sleep Journal</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Spacire (The Valen Collective LTD). Company Registered in England &amp; Wales. Reg: 16695657.</p>
                <div class="footer-legal">
                    <a href="https://spacire.com/policies/privacy-policy">Privacy Policy</a>
                    <a href="https://spacire.com/policies/terms-of-service">Terms of Service</a>
                </div>
            </div>
        </div>
    </footer>
    
    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const CONFIG = {
            APPWRITE_ENDPOINT: 'https://cloud.appwrite.io/v1',
            APPWRITE_PROJECT_ID: '682579e1002cf20ca061',
            APPWRITE_FUNCTION_ID: '6825b57d003c9a498279',
            APPWRITE_DATABASE_ID: '682857450019d695c701',
            APPWRITE_COLLECTION_ID: '68285760000028460a3d'
        };
        
        // ========================================
        // STATE
        // ========================================
        const STORAGE_KEY = 'spacire_sleep_tracker';
        let sleepData = [];
        let selectedDate = new Date();
        let selectedQuality = null;
        let chartRange = 7;
        let currentReportType = 'doctor';
        
        // ========================================
        // INITIALIZATION
        // ========================================
        function init() {
            loadData();
            updateDateDisplay();
            updateQuickStats();
            loadExistingEntry();
            updateReportButtons();
        }
        
        // ========================================
        // DATA MANAGEMENT
        // ========================================
        function loadData() {
            try {
                const stored = localStorage.getItem(STORAGE_KEY);
                if (stored) {
                    sleepData = JSON.parse(stored);
                }
            } catch (e) {
                console.error('Error loading data:', e);
                sleepData = [];
            }
        }
        
        function saveData() {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(sleepData));
            } catch (e) {
                console.error('Error saving data:', e);
                showToast('Error saving data', 'error');
            }
        }
        
        // ========================================
        // MOBILE MENU
        // ========================================
        function toggleMobileMenu() {
            document.getElementById('mobileNav').classList.toggle('active');
        }
        
        // ========================================
        // TABS
        // ========================================
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(`${tab}Tab`).classList.add('active');
            
            if (tab === 'trends') {
                renderCharts();
            } else if (tab === 'history') {
                renderHistory();
            } else if (tab === 'insights') {
                renderInsights();
            } else if (tab === 'reports') {
                updateReportButtons();
            }
        }
        
        // ========================================
        // DATE NAVIGATION
        // ========================================
        function updateDateDisplay() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const selected = new Date(selectedDate);
            selected.setHours(0, 0, 0, 0);
            
            let displayText;
            if (selected.getTime() === today.getTime()) {
                displayText = 'Today';
            } else if (selected.getTime() === today.getTime() - 86400000) {
                displayText = 'Yesterday';
            } else {
                displayText = selected.toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric' });
            }
            
            document.getElementById('currentDate').textContent = displayText;
        }
        
        function changeDate(delta) {
            selectedDate.setDate(selectedDate.getDate() + delta);
            updateDateDisplay();
            loadExistingEntry();
        }
        
        function goToToday() {
            selectedDate = new Date();
            updateDateDisplay();
            loadExistingEntry();
        }
        
        function getDateKey(date) {
            return date.toISOString().split('T')[0];
        }
        
        // ========================================
        // FORM HANDLING
        // ========================================
        function selectQuality(rating, btn) {
            selectedQuality = rating;
            document.querySelectorAll('.quality-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
        }
        
        function toggleFactor(element) {
            element.classList.toggle('active');
            element.querySelector('input').checked = element.classList.contains('active');
        }
        
        function loadExistingEntry() {
            const dateKey = getDateKey(selectedDate);
            const existing = sleepData.find(e => e.date === dateKey);
            
            // Reset form
            selectedQuality = null;
            document.querySelectorAll('.quality-btn').forEach(b => b.classList.remove('selected'));
            document.querySelectorAll('.factor-toggle').forEach(f => {
                f.classList.remove('active');
                f.querySelector('input').checked = false;
            });
            document.getElementById('notes').value = '';
            
            if (existing) {
                document.getElementById('bedtime').value = existing.bedtime;
                document.getElementById('latency').value = existing.latency;
                document.getElementById('wakeTime').value = existing.wakeTime;
                document.getElementById('waso').value = existing.waso;
                document.getElementById('notes').value = existing.notes || '';
                
                if (existing.quality) {
                    selectedQuality = existing.quality;
                    document.querySelectorAll('.quality-btn')[existing.quality - 1].classList.add('selected');
                }
                
                if (existing.factors) {
                    existing.factors.forEach(factor => {
                        const toggle = document.querySelector(`.factor-toggle input[value="${factor}"]`);
                        if (toggle) {
                            toggle.checked = true;
                            toggle.closest('.factor-toggle').classList.add('active');
                        }
                    });
                }
            }
        }
        
        // ========================================
        // CALCULATIONS
        // ========================================
        function calculateSleepMetrics(entry) {
            const bedtime = parseTime(entry.bedtime);
            const wakeTime = parseTime(entry.wakeTime);
            const latency = parseInt(entry.latency);
            const waso = parseInt(entry.waso);
            
            // Time in bed (handle overnight)
            let timeInBed = (wakeTime - bedtime) / 60000; // minutes
            if (timeInBed < 0) timeInBed += 1440; // add 24 hours
            
            // Actual sleep time
            const sleepTime = timeInBed - latency - waso;
            
            // Sleep efficiency
            const efficiency = Math.round((sleepTime / timeInBed) * 100);
            
            return {
                timeInBed: Math.round(timeInBed),
                sleepTime: Math.max(0, Math.round(sleepTime)),
                efficiency: Math.max(0, Math.min(100, efficiency))
            };
        }
        
        function parseTime(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const date = new Date();
            date.setHours(hours, minutes, 0, 0);
            return date;
        }
        
        function formatDuration(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h}h ${m}m`;
        }
        
        // ========================================
        // SAVE ENTRY
        // ========================================
        function saveSleepEntry() {
            const bedtime = document.getElementById('bedtime').value;
            const latency = document.getElementById('latency').value;
            const wakeTime = document.getElementById('wakeTime').value;
            const waso = document.getElementById('waso').value;
            const notes = document.getElementById('notes').value.trim();
            
            if (!bedtime || !wakeTime) {
                showToast('Please enter bedtime and wake time', 'error');
                return;
            }
            
            if (!selectedQuality) {
                showToast('Please rate your sleep quality', 'error');
                return;
            }
            
            // Collect factors
            const factors = [];
            document.querySelectorAll('.factor-toggle input:checked').forEach(input => {
                factors.push(input.value);
            });
            
            const dateKey = getDateKey(selectedDate);
            const entry = {
                date: dateKey,
                bedtime,
                latency,
                wakeTime,
                waso,
                quality: selectedQuality,
                factors,
                notes,
                timestamp: new Date().toISOString()
            };
            
            // Calculate metrics
            const metrics = calculateSleepMetrics(entry);
            entry.sleepTime = metrics.sleepTime;
            entry.timeInBed = metrics.timeInBed;
            entry.efficiency = metrics.efficiency;
            
            // Update or add entry
            const existingIndex = sleepData.findIndex(e => e.date === dateKey);
            if (existingIndex >= 0) {
                sleepData[existingIndex] = entry;
            } else {
                sleepData.push(entry);
            }
            
            // Sort by date
            sleepData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            saveData();
            updateQuickStats();
            updateReportButtons();
            showToast('Sleep entry saved!', 'success');
        }
        
        // ========================================
        // QUICK STATS
        // ========================================
        function updateQuickStats() {
            document.getElementById('statEntries').textContent = sleepData.length;
            
            if (sleepData.length === 0) {
                document.getElementById('statAvgDuration').textContent = '--';
                document.getElementById('statAvgEfficiency').textContent = '--%';
                document.getElementById('statAvgQuality').textContent = '--';
                return;
            }
            
            const avgDuration = sleepData.reduce((sum, e) => sum + e.sleepTime, 0) / sleepData.length;
            const avgEfficiency = sleepData.reduce((sum, e) => sum + e.efficiency, 0) / sleepData.length;
            const avgQuality = sleepData.reduce((sum, e) => sum + e.quality, 0) / sleepData.length;
            
            document.getElementById('statAvgDuration').textContent = formatDuration(Math.round(avgDuration));
            document.getElementById('statAvgEfficiency').textContent = `${Math.round(avgEfficiency)}%`;
            document.getElementById('statAvgQuality').textContent = avgQuality.toFixed(1);
        }
        
        // ========================================
        // CHARTS
        // ========================================
        function setRange(days, btn) {
            chartRange = days;
            document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderCharts();
        }
        
        function renderCharts() {
            const entries = getEntriesForRange(chartRange);
            
            if (entries.length === 0) {
                document.getElementById('durationChart').parentElement.innerHTML = '<div class="empty-state"><div class="empty-icon">&#128202;</div><div class="empty-title">No Data Yet</div><div class="empty-text">Start logging your sleep to see trends.</div></div>';
                return;
            }
            
            renderDurationChart(entries);
            renderEfficiencyChart(entries);
            renderQualityChart(entries);
        }
        
        function getEntriesForRange(days) {
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            cutoff.setHours(0, 0, 0, 0);
            
            return sleepData
                .filter(e => new Date(e.date) >= cutoff)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
        }
        
        function renderDurationChart(entries) {
            const canvas = document.getElementById('durationChart');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.parentElement.offsetWidth - 48;
            canvas.height = 200;
            
            const padding = { top: 20, right: 20, bottom: 40, left: 50 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const maxDuration = Math.max(...entries.map(e => e.sleepTime), 540);
            const barWidth = chartWidth / entries.length - 10;
            
            // Draw target zone (7-9 hours)
            const y9h = padding.top + chartHeight - (540 / maxDuration) * chartHeight;
            const y7h = padding.top + chartHeight - (420 / maxDuration) * chartHeight;
            ctx.fillStyle = 'rgba(40, 167, 69, 0.1)';
            ctx.fillRect(padding.left, y9h, chartWidth, y7h - y9h);
            
            // Draw bars
            entries.forEach((entry, i) => {
                const x = padding.left + i * (chartWidth / entries.length) + 5;
                const barHeight = (entry.sleepTime / maxDuration) * chartHeight;
                const y = padding.top + chartHeight - barHeight;
                
                ctx.fillStyle = entry.sleepTime >= 420 && entry.sleepTime <= 540 ? '#042548' : '#6c757d';
                ctx.fillRect(x, y, barWidth, barHeight);
            });
            
            // X-axis labels
            ctx.fillStyle = '#777';
            ctx.font = '10px Domine, Georgia, serif';
            ctx.textAlign = 'center';
            entries.forEach((entry, i) => {
                const x = padding.left + i * (chartWidth / entries.length) + barWidth / 2 + 5;
                const date = new Date(entry.date);
                ctx.fillText(date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }), x, canvas.height - 10);
            });
            
            // Y-axis labels
            ctx.textAlign = 'right';
            ctx.fillText('9h', padding.left - 5, y9h + 4);
            ctx.fillText('7h', padding.left - 5, y7h + 4);
            ctx.fillText('0h', padding.left - 5, padding.top + chartHeight);
        }
        
        function renderEfficiencyChart(entries) {
            const canvas = document.getElementById('efficiencyChart');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.parentElement.offsetWidth - 48;
            canvas.height = 200;
            
            const padding = { top: 20, right: 20, bottom: 40, left: 50 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw good zone (85%+)
            const y85 = padding.top + chartHeight - (85 / 100) * chartHeight;
            ctx.fillStyle = 'rgba(40, 167, 69, 0.1)';
            ctx.fillRect(padding.left, padding.top, chartWidth, y85 - padding.top);
            
            // Draw line
            ctx.strokeStyle = '#E0B252';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            entries.forEach((entry, i) => {
                const x = padding.left + (i / (entries.length - 1 || 1)) * chartWidth;
                const y = padding.top + chartHeight - (entry.efficiency / 100) * chartHeight;
                
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Draw points
            entries.forEach((entry, i) => {
                const x = padding.left + (i / (entries.length - 1 || 1)) * chartWidth;
                const y = padding.top + chartHeight - (entry.efficiency / 100) * chartHeight;
                
                ctx.fillStyle = entry.efficiency >= 85 ? '#28a745' : '#ffc107';
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI * 2);
                ctx.fill();
            });
            
            // Y-axis labels
            ctx.fillStyle = '#777';
            ctx.font = '10px Domine, Georgia, serif';
            ctx.textAlign = 'right';
            ctx.fillText('100%', padding.left - 5, padding.top + 4);
            ctx.fillText('85%', padding.left - 5, y85 + 4);
            ctx.fillText('0%', padding.left - 5, padding.top + chartHeight);
        }
        
        function renderQualityChart(entries) {
            const canvas = document.getElementById('qualityChart');
            const ctx = canvas.getContext('2d');
            
            canvas.width = canvas.parentElement.offsetWidth - 48;
            canvas.height = 200;
            
            const padding = { top: 20, right: 20, bottom: 40, left: 50 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = chartWidth / entries.length - 10;
            const colors = ['#6c757d', '#dc3545', '#ffc107', '#17a2b8', '#28a745'];
            
            entries.forEach((entry, i) => {
                const x = padding.left + i * (chartWidth / entries.length) + 5;
                const barHeight = (entry.quality / 5) * chartHeight;
                const y = padding.top + chartHeight - barHeight;
                
                ctx.fillStyle = colors[entry.quality - 1];
                ctx.fillRect(x, y, barWidth, barHeight);
            });
            
            // X-axis labels
            ctx.fillStyle = '#777';
            ctx.font = '10px Domine, Georgia, serif';
            ctx.textAlign = 'center';
            entries.forEach((entry, i) => {
                const x = padding.left + i * (chartWidth / entries.length) + barWidth / 2 + 5;
                const date = new Date(entry.date);
                ctx.fillText(date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' }), x, canvas.height - 10);
            });
            
            // Y-axis
            ctx.textAlign = 'right';
            ctx.fillText('5', padding.left - 5, padding.top + 4);
            ctx.fillText('1', padding.left - 5, padding.top + chartHeight);
        }
        
        // ========================================
        // HISTORY
        // ========================================
        function renderHistory() {
            const container = document.getElementById('historyContent');
            
            if (sleepData.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">&#128203;</div><div class="empty-title">No Entries Yet</div><div class="empty-text">Start logging your sleep to see your history here.</div></div>';
                return;
            }
            
            const qualityLabels = ['Terrible', 'Poor', 'Fair', 'Good', 'Excellent'];
            const qualityClasses = ['quality-terrible', 'quality-poor', 'quality-fair', 'quality-good', 'quality-excellent'];
            
            let html = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Bedtime</th>
                            <th>Wake</th>
                            <th>Duration</th>
                            <th>Efficiency</th>
                            <th>Quality</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sleepData.forEach((entry, index) => {
                const date = new Date(entry.date);
                html += `
                    <tr>
                        <td>${date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</td>
                        <td>${entry.bedtime}</td>
                        <td>${entry.wakeTime}</td>
                        <td>${formatDuration(entry.sleepTime)}</td>
                        <td>${entry.efficiency}%</td>
                        <td><span class="quality-badge ${qualityClasses[entry.quality - 1]}">${qualityLabels[entry.quality - 1]}</span></td>
                        <td><button class="delete-btn" onclick="deleteEntry(${index})">&#10005;</button></td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        function deleteEntry(index) {
            if (confirm('Delete this sleep entry?')) {
                sleepData.splice(index, 1);
                saveData();
                renderHistory();
                updateQuickStats();
                updateReportButtons();
                showToast('Entry deleted', 'success');
            }
        }
        
        // ========================================
        // INSIGHTS
        // ========================================
        function renderInsights() {
            renderWeeklySummary();
            generateInsights();
        }
        
        function renderWeeklySummary() {
            const entries = getEntriesForRange(7);
            const container = document.getElementById('weeklySummary');
            
            if (entries.length === 0) {
                container.innerHTML = '<div class="no-data">Log at least one night to see your weekly summary.</div>';
                return;
            }
            
            const avgDuration = entries.reduce((sum, e) => sum + e.sleepTime, 0) / entries.length;
            const avgEfficiency = entries.reduce((sum, e) => sum + e.efficiency, 0) / entries.length;
            const avgQuality = entries.reduce((sum, e) => sum + e.quality, 0) / entries.length;
            const avgLatency = entries.reduce((sum, e) => sum + parseInt(e.latency), 0) / entries.length;
            const avgWaso = entries.reduce((sum, e) => sum + parseInt(e.waso), 0) / entries.length;
            
            // Count factors
            const factorCounts = {};
            entries.forEach(e => {
                e.factors.forEach(f => {
                    factorCounts[f] = (factorCounts[f] || 0) + 1;
                });
            });
            
            const topFactors = Object.entries(factorCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3)
                .map(([f, count]) => `${f} (${count}x)`);
            
            container.innerHTML = `
                <div class="summary-card">
                    <div class="summary-card-title">Sleep Metrics</div>
                    <div class="summary-item">
                        <span class="summary-item-label">Average Duration</span>
                        <span class="summary-item-value">${formatDuration(Math.round(avgDuration))}</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-item-label">Average Efficiency</span>
                        <span class="summary-item-value">${Math.round(avgEfficiency)}%</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-item-label">Average Quality</span>
                        <span class="summary-item-value">${avgQuality.toFixed(1)} / 5</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-item-label">Nights Logged</span>
                        <span class="summary-item-value">${entries.length}</span>
                    </div>
                </div>
                <div class="summary-card">
                    <div class="summary-card-title">Sleep Timing</div>
                    <div class="summary-item">
                        <span class="summary-item-label">Avg Time to Fall Asleep</span>
                        <span class="summary-item-value">${Math.round(avgLatency)} min</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-item-label">Avg Time Awake at Night</span>
                        <span class="summary-item-value">${Math.round(avgWaso)} min</span>
                    </div>
                    <div class="summary-item">
                        <span class="summary-item-label">Most Common Factors</span>
                        <span class="summary-item-value">${topFactors.length > 0 ? topFactors.join(', ') : 'None'}</span>
                    </div>
                </div>
            `;
        }
        
        function generateInsights() {
            const entries = getEntriesForRange(14);
            const container = document.getElementById('insightsContent');
            
            if (entries.length < 3) {
                container.innerHTML = '<div class="no-data">Log at least 3 nights to get personalized insights.</div>';
                return;
            }
            
            const insights = [];
            
            const avgDuration = entries.reduce((sum, e) => sum + e.sleepTime, 0) / entries.length;
            const avgEfficiency = entries.reduce((sum, e) => sum + e.efficiency, 0) / entries.length;
            const avgQuality = entries.reduce((sum, e) => sum + e.quality, 0) / entries.length;
            
            // Duration insight
            if (avgDuration < 420) {
                insights.push({
                    title: 'You May Be Sleep Deprived',
                    text: `Your average sleep duration is ${formatDuration(Math.round(avgDuration))}, which is below the recommended 7-9 hours. Consider going to bed earlier.`
                });
            } else if (avgDuration > 540) {
                insights.push({
                    title: 'You Sleep More Than Average',
                    text: `Your average sleep duration is ${formatDuration(Math.round(avgDuration))}. If you still feel tired, the quality of your sleep may need attention.`
                });
            } else {
                insights.push({
                    title: 'Good Sleep Duration',
                    text: `Your average sleep duration of ${formatDuration(Math.round(avgDuration))} is within the recommended 7-9 hour range. Keep it up!`
                });
            }
            
            // Efficiency insight
            if (avgEfficiency < 85) {
                insights.push({
                    title: 'Your Sleep Efficiency Could Improve',
                    text: `Your average efficiency is ${Math.round(avgEfficiency)}%. This means you're spending more time in bed awake than ideal. Try going to bed only when sleepy.`
                });
            }
            
            // Factor correlations
            const factorQuality = {};
            entries.forEach(e => {
                e.factors.forEach(f => {
                    if (!factorQuality[f]) factorQuality[f] = [];
                    factorQuality[f].push(e.quality);
                });
            });
            
            for (const [factor, qualities] of Object.entries(factorQuality)) {
                if (qualities.length >= 3) {
                    const avgFactorQuality = qualities.reduce((a, b) => a + b, 0) / qualities.length;
                    if (avgFactorQuality < avgQuality - 0.5) {
                        const factorNames = {
                            caffeine: 'caffeine', alcohol: 'alcohol', exercise: 'exercise',
                            stress: 'stress', screens: 'late screen use', lateMeal: 'late meals',
                            nap: 'napping', noise: 'noise'
                        };
                        insights.push({
                            title: `${factorNames[factor] || factor} May Affect Your Sleep`,
                            text: `On nights with ${factorNames[factor] || factor}, your average quality is ${avgFactorQuality.toFixed(1)} vs ${avgQuality.toFixed(1)} overall.`
                        });
                    }
                }
            }
            
            if (insights.length === 0) {
                insights.push({
                    title: 'Keep Logging',
                    text: 'Continue tracking your sleep to discover more personalized insights.'
                });
            }
            
            container.innerHTML = insights.map(i => `
                <div class="insight-card">
                    <div class="insight-title">${i.title}</div>
                    <p class="insight-text">${i.text}</p>
                </div>
            `).join('');
        }
        
        // ========================================
        // EXPORT
        // ========================================
        function exportCSV() {
            if (sleepData.length === 0) {
                showToast('No data to export', 'error');
                return;
            }
            
            const headers = ['Date', 'Bedtime', 'Wake Time', 'Sleep Duration (min)', 'Efficiency (%)', 'Quality', 'Factors', 'Notes'];
            const rows = sleepData.map(e => [
                e.date,
                e.bedtime,
                e.wakeTime,
                e.sleepTime,
                e.efficiency,
                e.quality,
                e.factors.join('; '),
                e.notes || ''
            ]);
            
            const csv = [headers, ...rows].map(r => r.map(c => `"${c}"`).join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sleep-tracker-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            showToast('CSV downloaded!', 'success');
        }
        
        function copyData() {
            if (sleepData.length === 0) {
                showToast('No data to copy', 'error');
                return;
            }
            
            const text = sleepData.map(e => 
                `${e.date}: ${formatDuration(e.sleepTime)} sleep, ${e.efficiency}% efficiency, quality ${e.quality}/5`
            ).join('\n');
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Data copied to clipboard!', 'success');
            });
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to delete ALL your sleep data? This cannot be undone.')) {
                sleepData = [];
                saveData();
                updateQuickStats();
                renderHistory();
                updateReportButtons();
                showToast('All data cleared', 'success');
            }
        }
        
        // ========================================
        // REPORTS
        // ========================================
        function updateReportButtons() {
            const doctorBtn = document.getElementById('doctorReportBtn');
            const emailBtn = document.getElementById('emailReportBtn');
            
            if (sleepData.length === 0) {
                doctorBtn.disabled = true;
                emailBtn.disabled = true;
                doctorBtn.textContent = 'Log sleep first';
                emailBtn.textContent = 'Log sleep first';
            } else {
                doctorBtn.disabled = false;
                emailBtn.disabled = false;
                doctorBtn.textContent = 'Generate PDF Report';
                emailBtn.textContent = 'Email Report to Me';
            }
        }
        
        function openReportModal(type) {
            if (sleepData.length === 0) {
                showToast('Please log at least one night of sleep first', 'error');
                return;
            }
            
            currentReportType = type;
            const modal = document.getElementById('reportModal');
            const title = document.getElementById('modalTitle');
            const desc = document.getElementById('modalDescription');
            const submitText = document.getElementById('submitBtnText');
            
            if (type === 'doctor') {
                title.textContent = 'Generate Sleep Report for Doctor';
                desc.textContent = 'Enter your email to receive a professional PDF report you can share with your healthcare provider.';
                submitText.textContent = 'Generate & Send Report';
            } else {
                title.textContent = 'Email My Sleep Report';
                desc.textContent = 'Enter your email to receive your personalized sleep report with insights and recommendations.';
                submitText.textContent = 'Send Report';
            }
            
            // Reset form
            document.getElementById('reportEmail').value = '';
            document.getElementById('marketingConsent').checked = false;
            document.getElementById('privacyConsent').checked = false;
            
            modal.classList.add('active');
        }
        
        function closeReportModal() {
            document.getElementById('reportModal').classList.remove('active');
        }
        
        async function submitReport() {
            const email = document.getElementById('reportEmail').value.trim();
            const marketingConsent = document.getElementById('marketingConsent').checked;
            const privacyConsent = document.getElementById('privacyConsent').checked;
            
            // Validation
            if (!email) {
                showToast('Please enter your email address', 'error');
                return;
            }
            
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showToast('Please enter a valid email address', 'error');
                return;
            }
            
            if (!privacyConsent) {
                showToast('Please agree to the Privacy Policy to continue', 'error');
                return;
            }
            
            const submitBtn = document.getElementById('modalSubmitBtn');
            const submitText = document.getElementById('submitBtnText');
            submitBtn.disabled = true;
            submitText.innerHTML = '<span class="spinner"></span>Generating...';
            
            try {
                // Generate report data
                const reportData = generateReportData();
                
                // Send to Appwrite
                await sendReportEmail(email, reportData, marketingConsent);
                
                // Also generate and download PDF for doctor report
                if (currentReportType === 'doctor') {
                    await generateAndDownloadPDF(reportData);
                }
                
                closeReportModal();
                showToast('Report sent! Check your email.', 'success');
                
            } catch (error) {
                console.error('Error generating report:', error);
                showToast('Error sending report. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitText.textContent = currentReportType === 'doctor' ? 'Generate & Send Report' : 'Send Report';
            }
        }
        
        function generateReportData() {
            const entries = sleepData.slice(0, 30); // Last 30 entries
            
            if (entries.length === 0) {
                return null;
            }
            
            // Calculate statistics
            const avgDuration = entries.reduce((sum, e) => sum + e.sleepTime, 0) / entries.length;
            const avgEfficiency = entries.reduce((sum, e) => sum + e.efficiency, 0) / entries.length;
            const avgQuality = entries.reduce((sum, e) => sum + e.quality, 0) / entries.length;
            const avgLatency = entries.reduce((sum, e) => sum + parseInt(e.latency), 0) / entries.length;
            const avgWaso = entries.reduce((sum, e) => sum + parseInt(e.waso), 0) / entries.length;
            
            // Factor analysis
            const factorCounts = {};
            const factorQuality = {};
            entries.forEach(e => {
                e.factors.forEach(f => {
                    factorCounts[f] = (factorCounts[f] || 0) + 1;
                    if (!factorQuality[f]) factorQuality[f] = [];
                    factorQuality[f].push(e.quality);
                });
            });
            
            // Generate insights
            const insights = [];
            
            if (avgDuration < 420) {
                insights.push({ title: 'Below Recommended Duration', text: `Average sleep of ${formatDuration(Math.round(avgDuration))} is below the 7-9 hour recommendation.` });
            }
            if (avgEfficiency < 85) {
                insights.push({ title: 'Low Sleep Efficiency', text: `Average efficiency of ${Math.round(avgEfficiency)}% is below the 85% threshold, suggesting sleep disruption.` });
            }
            if (avgLatency > 30) {
                insights.push({ title: 'Extended Sleep Latency', text: `Average time to fall asleep of ${Math.round(avgLatency)} minutes may indicate difficulty initiating sleep.` });
            }
            
            // Dates
            const dateRange = {
                start: entries[entries.length - 1].date,
                end: entries[0].date
            };
            
            return {
                generatedAt: new Date().toISOString(),
                dateRange,
                totalNights: entries.length,
                statistics: {
                    avgDuration: Math.round(avgDuration),
                    avgDurationFormatted: formatDuration(Math.round(avgDuration)),
                    avgEfficiency: Math.round(avgEfficiency),
                    avgQuality: avgQuality.toFixed(1),
                    avgLatency: Math.round(avgLatency),
                    avgWaso: Math.round(avgWaso)
                },
                factorCounts,
                factorQuality,
                insights,
                entries: entries.map(e => ({
                    date: e.date,
                    bedtime: e.bedtime,
                    wakeTime: e.wakeTime,
                    sleepTime: e.sleepTime,
                    sleepTimeFormatted: formatDuration(e.sleepTime),
                    efficiency: e.efficiency,
                    quality: e.quality,
                    factors: e.factors,
                    notes: e.notes
                }))
            };
        }
        
        async function sendReportEmail(email, reportData, marketingConsent) {
            const payload = {
                toolType: 'sleep-tracker',
                email: email,
                marketingConsent: marketingConsent,
                results: reportData
            };
            
            const response = await fetch(`${CONFIG.APPWRITE_ENDPOINT}/functions/${CONFIG.APPWRITE_FUNCTION_ID}/executions`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Appwrite-Project': CONFIG.APPWRITE_PROJECT_ID
                },
                body: JSON.stringify({
                    body: JSON.stringify(payload),
                    async: true
                })
            });
            
            if (!response.ok) {
                throw new Error('Failed to send email');
            }
            
            return response.json();
        }
        
        async function generateAndDownloadPDF(reportData) {
            // Build HTML for PDF
            const container = document.getElementById('pdfReportContainer');
            
            const qualityLabels = ['Terrible', 'Poor', 'Fair', 'Good', 'Excellent'];
            const factorNames = {
                caffeine: 'Caffeine', alcohol: 'Alcohol', exercise: 'Exercise',
                stress: 'Stress', screens: 'Late Screens', lateMeal: 'Late Meal',
                nap: 'Napping', noise: 'Noise'
            };
            
            const startDate = new Date(reportData.dateRange.start).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            const endDate = new Date(reportData.dateRange.end).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
            
            container.innerHTML = `
                <div class="pdf-report">
                    <div class="pdf-header">
                        <div class="pdf-logo">Spacire</div>
                        <div class="pdf-title">Sleep Report for Healthcare Provider</div>
                        <div class="pdf-subtitle">Generated on ${new Date().toLocaleDateString('en-GB', { day: 'numeric', month: 'long', year: 'numeric' })}</div>
                        <div class="pdf-subtitle">Report Period: ${startDate} - ${endDate} (${reportData.totalNights} nights)</div>
                    </div>
                    
                    <div class="pdf-section">
                        <div class="pdf-section-title">Summary Statistics</div>
                        <div class="pdf-stats-grid">
                            <div class="pdf-stat-box">
                                <div class="pdf-stat-value">${reportData.statistics.avgDurationFormatted}</div>
                                <div class="pdf-stat-label">Avg Duration</div>
                            </div>
                            <div class="pdf-stat-box">
                                <div class="pdf-stat-value">${reportData.statistics.avgEfficiency}%</div>
                                <div class="pdf-stat-label">Avg Efficiency</div>
                            </div>
                            <div class="pdf-stat-box">
                                <div class="pdf-stat-value">${reportData.statistics.avgQuality}/5</div>
                                <div class="pdf-stat-label">Avg Quality</div>
                            </div>
                            <div class="pdf-stat-box">
                                <div class="pdf-stat-value">${reportData.statistics.avgLatency} min</div>
                                <div class="pdf-stat-label">Avg Latency</div>
                            </div>
                        </div>
                        <p style="font-size: 10px; color: #555;">
                            <strong>WASO (Wake After Sleep Onset):</strong> ${reportData.statistics.avgWaso} minutes average
                        </p>
                    </div>
                    
                    ${reportData.insights.length > 0 ? `
                    <div class="pdf-section">
                        <div class="pdf-section-title">Clinical Observations</div>
                        ${reportData.insights.map(i => `
                            <div class="pdf-insights">
                                <div class="pdf-insight-title">${i.title}</div>
                                <p class="pdf-insight-text">${i.text}</p>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="pdf-section">
                        <div class="pdf-section-title">Daily Sleep Log</div>
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Bedtime</th>
                                    <th>Wake</th>
                                    <th>Duration</th>
                                    <th>Efficiency</th>
                                    <th>Quality</th>
                                    <th>Factors</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${reportData.entries.slice(0, 14).map(e => `
                                    <tr>
                                        <td>${new Date(e.date).toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })}</td>
                                        <td>${e.bedtime}</td>
                                        <td>${e.wakeTime}</td>
                                        <td>${e.sleepTimeFormatted}</td>
                                        <td>${e.efficiency}%</td>
                                        <td>${qualityLabels[e.quality - 1]}</td>
                                        <td>${e.factors.map(f => factorNames[f] || f).join(', ') || '-'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${reportData.entries.length > 14 ? `<p style="font-size: 10px; color: #777; margin-top: 10px;">Showing most recent 14 of ${reportData.entries.length} entries.</p>` : ''}
                    </div>
                    
                    ${Object.keys(reportData.factorCounts).length > 0 ? `
                    <div class="pdf-section">
                        <div class="pdf-section-title">Factor Analysis</div>
                        <table class="pdf-table">
                            <thead>
                                <tr>
                                    <th>Factor</th>
                                    <th>Occurrences</th>
                                    <th>Avg Quality When Present</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.entries(reportData.factorCounts).map(([f, count]) => {
                                    const avgQ = reportData.factorQuality[f].reduce((a, b) => a + b, 0) / reportData.factorQuality[f].length;
                                    return `
                                        <tr>
                                            <td>${factorNames[f] || f}</td>
                                            <td>${count} nights</td>
                                            <td>${avgQ.toFixed(1)}/5</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                    ` : ''}
                    
                    <div class="pdf-disclaimer">
                        <div class="pdf-disclaimer-title">Medical Disclaimer</div>
                        <p style="margin: 0;">This sleep diary report is based on self-reported data and is intended for informational purposes only. It is not a substitute for professional medical advice, diagnosis, or treatment. The data presented reflects the user's subjective assessment of their sleep patterns. Healthcare providers should use this information as one component of a comprehensive clinical evaluation. Sleep disorders require professional diagnosis using validated clinical tools and, when appropriate, polysomnography or other objective sleep testing methods.</p>
                    </div>
                    
                    <div class="pdf-footer">
                        <p>Generated by Spacire Sleep Tracker | tools.spacire.com/sleep-tracker</p>
                        <p>For more sleep resources, visit spacire.com</p>
                    </div>
                </div>
            `;
            
            // Generate PDF using html2pdf
            const element = container.querySelector('.pdf-report');
            const opt = {
                margin: 10,
                filename: `sleep-report-${new Date().toISOString().split('T')[0]}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            await html2pdf().set(opt).from(element).save();
            
            // Clear container
            container.innerHTML = '';
        }
        
        // ========================================
        // TOAST
        // ========================================
        function showToast(message, type = '') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ========================================
        // INFO TOGGLES
        // ========================================
        function toggleInfo(header) {
            const toggle = header.closest('.info-toggle');
            const content = toggle.querySelector('.info-content');
            toggle.classList.toggle('open');
            content.classList.toggle('open');
        }
        
        // Initialize
        init();
    </script>
</body>
</html>
