<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Free Caffeine Sleep Calculator - Find your ideal caffeine cutoff time based on your metabolism and bedtime. See how caffeine affects your sleep quality.">
    <meta name="keywords" content="caffeine calculator, caffeine sleep calculator, caffeine half life, when to stop drinking coffee, caffeine cutoff time, coffee and sleep">
    <meta name="author" content="Spacire">
    <meta name="robots" content="index, follow">
    
    <title>Caffeine Sleep Calculator - Find Your Caffeine Cutoff Time | Spacire</title>
    
    <link rel="canonical" href="https://tools.spacire.com/caffeine-sleep-calculator">
    
    <meta property="og:title" content="Caffeine Sleep Calculator - Optimize Coffee Timing for Better Sleep">
    <meta property="og:description" content="Calculate how caffeine affects your sleep based on your metabolism, drinks, and bedtime.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://tools.spacire.com/caffeine-sleep-calculator">
    <meta property="og:site_name" content="Spacire Sleep Tools">
    
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Caffeine Sleep Calculator - Find Your Ideal Cutoff Time">
    <meta name="twitter:description" content="Personalized caffeine timing based on your metabolism and sleep schedule.">
    
    <link rel="icon" type="image/png" href="images/favicon.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Domine:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebApplication",
        "name": "Caffeine Sleep Calculator",
        "description": "Calculate your ideal caffeine cutoff time based on metabolism factors and see how caffeine affects your sleep quality.",
        "url": "https://tools.spacire.com/caffeine-sleep-calculator",
        "applicationCategory": "HealthApplication",
        "operatingSystem": "Web Browser",
        "offers": {"@type": "Offer", "price": "0", "priceCurrency": "GBP"},
        "publisher": {"@type": "Organization", "name": "Spacire", "url": "https://spacire.com"}
    }
    </script>
    
    <style>
        :root {
            --primary: #042548;
            --primary-light: #0a3a6b;
            --accent: #E0B252;
            --accent-light: #f5e6c4;
            --text-primary: #1a1a1a;
            --text-secondary: #555;
            --text-light: #777;
            --text-muted: #888;
            --bg: #ffffff;
            --bg-light: #f8f9fa;
            --hover: #f8f9fa;
            --border: #e0e0e0;
            --success: #d4edda;
            --success-dark: #28a745;
            --warning: #fff3cd;
            --warning-dark: #ffc107;
            --error: #f8d7da;
            --error-dark: #dc3545;
            --info: #d1ecf1;
            --info-dark: #17a2b8;
            --caffeine: #6f4e37;
            --caffeine-light: #d4c4b5;
            --radius-sm: 6px;
            --radius-md: 10px;
            --radius-lg: 16px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.2s ease;
            --font-primary: 'Domine', Georgia, serif;
        }
        
        *, *::before, *::after { box-sizing: border-box; }
        body { margin: 0; padding: 0; font-family: var(--font-primary); background: #f5f5f5; color: var(--text-primary); line-height: 1.6; }
        
        /* Header */
        .site-header { background: var(--primary); padding: 16px 0; position: sticky; top: 0; z-index: 100; }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo-link { text-decoration: none; }
        .logo-text { font-size: 22px; font-weight: 700; color: #fff; letter-spacing: 0.02em; }
        .header-nav { display: flex; gap: 28px; }
        .header-nav a { color: rgba(255,255,255,0.85); text-decoration: none; font-size: 14px; font-weight: 500; transition: var(--transition); }
        .header-nav a:hover { color: var(--accent); }
        .mobile-menu-btn { display: none; background: none; border: none; cursor: pointer; padding: 8px; flex-direction: column; gap: 5px; }
        .mobile-menu-btn span { display: block; width: 24px; height: 2px; background: #fff; transition: var(--transition); }
        .mobile-nav { display: none; background: var(--primary); padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); }
        .mobile-nav.active { display: block; }
        .mobile-nav a { display: block; color: rgba(255,255,255,0.85); text-decoration: none; padding: 12px 0; font-size: 14px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .mobile-nav a:last-child { border-bottom: none; }
        .mobile-nav a:hover { color: var(--accent); }
        @media (max-width: 768px) { .header-nav { display: none; } .mobile-menu-btn { display: flex; } }
        
        /* Breadcrumb */
        .breadcrumb { background: var(--hover); padding: 12px 0; border-bottom: 1px solid var(--border); }
        .breadcrumb-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; font-size: 13px; }
        .breadcrumb a { color: var(--primary); text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb span { color: var(--text-muted); margin: 0 8px; }
        
        /* Main Container */
        .main-container { max-width: 900px; margin: 0 auto; padding: 40px 20px 60px; }
        .page-title { text-align: center; margin-bottom: 32px; }
        .page-title h1 { font-size: 28px; font-weight: 700; color: var(--primary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 12px; }
        .page-subtitle { font-size: 16px; color: var(--text-secondary); max-width: 650px; margin: 0 auto; }
        
        /* Tool Card */
        .tool-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; box-shadow: var(--shadow-md); margin-bottom: 24px; }
        .tool-header { background: linear-gradient(135deg, var(--caffeine) 0%, #8b6914 100%); color: #fff; padding: 24px 28px; }
        .tool-header h2 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        .tool-header p { font-size: 14px; opacity: 0.9; margin: 0; }
        .tool-body { padding: 28px; }
        
        /* Form Elements */
        .form-section { margin-bottom: 24px; }
        .form-label { display: block; font-size: 14px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px; }
        .form-sublabel { font-size: 13px; color: var(--text-secondary); font-weight: 400; margin-left: 4px; }
        
        /* Time Input */
        .time-input { padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 16px; width: 150px; transition: var(--transition); }
        .time-input:focus { outline: none; border-color: var(--caffeine); }
        
        /* Drink Selector */
        .drink-section { background: var(--bg-light); border-radius: var(--radius-md); padding: 20px; margin-bottom: 24px; }
        .drink-section-title { font-size: 15px; font-weight: 600; color: var(--primary); margin-bottom: 16px; }
        
        .drink-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin-bottom: 16px; }
        .drink-btn { padding: 12px 10px; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 12px; cursor: pointer; transition: var(--transition); text-align: center; }
        .drink-btn:hover { border-color: var(--caffeine); background: var(--caffeine-light); }
        .drink-btn .drink-name { font-weight: 600; color: var(--primary); display: block; margin-bottom: 2px; }
        .drink-btn .drink-mg { color: var(--text-secondary); font-size: 11px; }
        
        .custom-drink { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; padding-top: 16px; border-top: 1px solid var(--border); }
        .custom-drink input { padding: 10px 12px; border: 2px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 14px; }
        .custom-drink input[type="text"] { flex: 1; min-width: 120px; }
        .custom-drink input[type="number"] { width: 80px; }
        .custom-drink input[type="time"] { width: 120px; }
        .add-drink-btn { padding: 10px 20px; background: var(--caffeine); color: #fff; border: none; border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 14px; font-weight: 600; cursor: pointer; transition: var(--transition); }
        .add-drink-btn:hover { background: #5a3d2b; }
        
        /* Added Drinks List */
        .drinks-list { margin-top: 20px; }
        .drinks-list-title { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 12px; }
        .drink-item { display: flex; justify-content: space-between; align-items: center; background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 12px 16px; margin-bottom: 8px; }
        .drink-item-info { display: flex; align-items: center; gap: 12px; }
        .drink-item-time { font-size: 13px; color: var(--text-secondary); min-width: 70px; }
        .drink-item-name { font-size: 14px; font-weight: 600; color: var(--primary); }
        .drink-item-mg { font-size: 13px; color: var(--caffeine); font-weight: 600; }
        .drink-remove { background: none; border: none; color: var(--error-dark); font-size: 18px; cursor: pointer; padding: 4px 8px; }
        .drink-remove:hover { color: #a71d2a; }
        .no-drinks { text-align: center; color: var(--text-muted); font-size: 14px; padding: 20px; }
        
        /* Metabolism Factors */
        .factors-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .factor-item { display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg-light); border-radius: var(--radius-md); cursor: pointer; transition: var(--transition); }
        .factor-item:hover { background: var(--caffeine-light); }
        .factor-item.selected { background: var(--caffeine-light); border: 2px solid var(--caffeine); }
        .factor-checkbox { width: 18px; height: 18px; accent-color: var(--caffeine); }
        .factor-label { font-size: 13px; color: var(--text-primary); }
        .factor-effect { font-size: 11px; color: var(--text-secondary); display: block; }
        
        /* Sensitivity Slider */
        .sensitivity-container { margin-top: 16px; }
        .sensitivity-slider { width: 100%; margin: 12px 0; accent-color: var(--caffeine); }
        .sensitivity-labels { display: flex; justify-content: space-between; font-size: 12px; color: var(--text-secondary); }
        .sensitivity-value { text-align: center; font-size: 14px; font-weight: 600; color: var(--caffeine); margin-top: 8px; }
        
        /* Calculate Button */
        .btn { padding: 16px 32px; border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 16px; font-weight: 600; cursor: pointer; transition: var(--transition); border: none; width: 100%; }
        .btn-primary { background: var(--accent); color: var(--primary); }
        .btn-primary:hover { background: #c9a047; transform: translateY(-1px); }
        
        /* Results Section */
        .results-section { display: none; margin-top: 32px; }
        .results-section.active { display: block; animation: fadeIn 0.4s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Main Result */
        .main-result { background: linear-gradient(135deg, var(--caffeine) 0%, #8b6914 100%); border-radius: var(--radius-lg); padding: 32px; text-align: center; color: #fff; margin-bottom: 24px; }
        .result-label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.9; margin-bottom: 8px; }
        .result-time { font-size: 52px; font-weight: 700; line-height: 1; margin-bottom: 8px; }
        .result-details { font-size: 14px; opacity: 0.9; }
        .result-badge { display: inline-block; background: var(--accent); color: var(--primary); padding: 6px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; margin-top: 12px; }
        
        /* Caffeine Chart */
        .chart-section { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; }
        .chart-title { font-size: 16px; font-weight: 600; color: var(--primary); margin-bottom: 16px; }
        .chart-container { position: relative; height: 200px; background: var(--bg-light); border-radius: var(--radius-md); overflow: hidden; }
        .chart-canvas { width: 100%; height: 100%; }
        .chart-legend { display: flex; gap: 20px; justify-content: center; margin-top: 16px; flex-wrap: wrap; }
        .legend-item { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
        .legend-color { width: 14px; height: 14px; border-radius: 3px; }
        
        /* Summary Cards */
        .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .summary-card { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-md); padding: 20px; text-align: center; }
        .summary-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .summary-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }
        .summary-card.warning { border-color: var(--warning-dark); background: var(--warning); }
        .summary-card.danger { border-color: var(--error-dark); background: var(--error); }
        .summary-card.success { border-color: var(--success-dark); background: var(--success); }
        
        /* Sleep Impact */
        .sleep-impact { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; }
        .impact-title { font-size: 16px; font-weight: 600; color: var(--primary); margin-bottom: 16px; }
        .impact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
        .impact-item { background: var(--bg-light); border-radius: var(--radius-md); padding: 16px; }
        .impact-item-title { font-size: 13px; color: var(--text-secondary); margin-bottom: 6px; }
        .impact-item-value { font-size: 18px; font-weight: 700; color: var(--primary); }
        .impact-item-desc { font-size: 12px; color: var(--text-muted); margin-top: 4px; }
        .impact-bar { height: 8px; background: var(--border); border-radius: 4px; margin-top: 8px; overflow: hidden; }
        .impact-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease; }
        
        /* Recommendations */
        .recommendations { background: var(--bg); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 24px; margin-bottom: 24px; }
        .rec-title { font-size: 16px; font-weight: 600; color: var(--primary); margin-bottom: 16px; }
        .rec-item { background: var(--bg-light); border-radius: var(--radius-md); padding: 16px; margin-bottom: 12px; display: flex; gap: 12px; }
        .rec-item:last-child { margin-bottom: 0; }
        .rec-icon { font-size: 20px; flex-shrink: 0; }
        .rec-content { flex: 1; }
        .rec-item-title { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 4px; }
        .rec-item-text { font-size: 13px; color: var(--text-secondary); margin: 0; }
        
        /* Email Capture */
        .email-capture { background: linear-gradient(135deg, #f8f9fa 0%, var(--caffeine-light) 100%); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 28px; text-align: center; margin-bottom: 24px; }
        .email-capture-title { font-size: 18px; font-weight: 600; color: var(--primary); margin-bottom: 8px; }
        .email-capture-text { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
        .email-form { display: flex; gap: 12px; max-width: 500px; margin: 0 auto; flex-wrap: wrap; }
        .email-input { flex: 1; min-width: 140px; padding: 14px 16px; border: 2px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 14px; transition: var(--transition); }
        .email-input:focus { outline: none; border-color: var(--caffeine); }
        .btn-email { background: var(--primary); color: #fff; min-width: 140px; }
        .btn-email:hover { background: var(--primary-light); }
        .email-success { display: none; color: var(--success-dark); font-weight: 600; margin-top: 12px; }
        .form-error { display: none; color: var(--error-dark); font-size: 13px; margin-top: 8px; }
        @media (max-width: 500px) { .email-form { flex-direction: column; } .email-input { min-width: 100%; } }
        
        /* Disclaimer */
        .disclaimer { background: var(--info); border: 1px solid var(--info-dark); border-radius: var(--radius-md); padding: 16px; margin-bottom: 24px; }
        .disclaimer-title { font-size: 14px; font-weight: 600; color: #0c5460; margin-bottom: 6px; }
        .disclaimer-text { font-size: 13px; color: #0c5460; line-height: 1.6; margin: 0; }
        
        /* New Calc Button */
        .new-calc-btn { display: block; margin: 20px auto 0; padding: 12px 24px; background: var(--hover); border: 2px solid var(--border); border-radius: var(--radius-md); font-family: var(--font-primary); font-size: 14px; font-weight: 600; color: var(--primary); cursor: pointer; transition: var(--transition); }
        .new-calc-btn:hover { border-color: var(--primary); }
        
        /* Info Toggles */
        .info-section { margin-top: 40px; }
        .info-toggle { background: #fff; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 12px; overflow: hidden; }
        .toggle-header { display: flex; justify-content: space-between; align-items: center; padding: 18px 24px; cursor: pointer; transition: var(--transition); }
        .toggle-header:hover { background: var(--hover); }
        .toggle-title { font-size: 15px; font-weight: 600; color: var(--primary); }
        .toggle-icon { font-size: 20px; color: var(--primary); transition: transform 0.3s ease; }
        .info-toggle.open .toggle-icon { transform: rotate(180deg); }
        .info-content { display: none; padding: 24px; background: #fff; border-top: 1px solid var(--border); }
        .info-content.open { display: block; animation: slideDown 0.3s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .info-content h4 { font-size: 15px; font-weight: 600; color: var(--primary); margin: 20px 0 10px; }
        .info-content h4:first-child { margin-top: 0; }
        .info-content p { font-size: 14px; color: var(--text-secondary); line-height: 1.7; margin-bottom: 12px; }
        .info-content ul { margin: 0 0 16px 0; padding-left: 20px; }
        .info-content li { font-size: 14px; color: var(--text-secondary); line-height: 1.6; margin-bottom: 6px; }
        .info-table { width: 100%; border-collapse: collapse; margin: 16px 0; font-size: 14px; }
        .info-table th, .info-table td { padding: 12px; text-align: left; border: 1px solid var(--border); }
        .info-table th { background: var(--hover); font-weight: 600; color: var(--primary); }
        .info-table td { color: var(--text-secondary); }
        .tools-grid-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 16px; }
        .tool-link-card { display: block; padding: 16px; background: var(--hover); border: 1px solid var(--border); border-radius: var(--radius-md); text-decoration: none; transition: var(--transition); }
        .tool-link-card:hover { border-color: var(--primary); transform: translateY(-2px); }
        .tool-link-card h5 { font-size: 14px; font-weight: 600; color: var(--primary); margin-bottom: 4px; }
        .tool-link-card p { font-size: 12px; color: var(--text-secondary); margin: 0; }
        .share-buttons { display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px; }
        .share-btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 16px; border-radius: var(--radius-md); text-decoration: none; font-size: 13px; font-weight: 600; transition: var(--transition); border: none; cursor: pointer; }
        .share-btn svg { width: 18px; height: 18px; fill: currentColor; }
        .share-btn.twitter { background: #1DA1F2; color: white; }
        .share-btn.twitter:hover { background: #1a8cd8; }
        .share-btn.facebook { background: #4267B2; color: white; }
        .share-btn.facebook:hover { background: #365899; }
        .share-btn.copy { background: var(--hover); color: var(--primary); border: 1px solid var(--border); }
        .share-btn.copy:hover { border-color: var(--primary); }
        
        /* Footer */
        .site-footer { background: var(--primary); color: #fff; padding: 48px 0 24px; margin-top: 60px; }
        .footer-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .footer-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 40px; margin-bottom: 40px; }
        .footer-section h4 { font-size: 14px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 16px; color: var(--accent); }
        .footer-section a { display: block; color: rgba(255,255,255,0.8); text-decoration: none; font-size: 14px; margin-bottom: 10px; transition: var(--transition); }
        .footer-section a:hover { color: var(--accent); }
        .footer-bottom { padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; font-size: 12px; color: rgba(255,255,255,0.6); }
        .footer-legal { margin-top: 12px; display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; }
        .footer-legal a { color: rgba(255,255,255,0.6); text-decoration: none; }
        .footer-legal a:hover { color: var(--accent); }
        @media (max-width: 768px) { .footer-grid { grid-template-columns: 1fr 1fr; gap: 24px; } }
        @media (max-width: 480px) { .footer-grid { grid-template-columns: 1fr; } }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="site-header">
        <div class="header-content">
            <a href="https://tools.spacire.com" class="logo-link">
                <span class="logo-text">Spacire</span>
            </a>
            <nav class="header-nav">
                <a href="https://tools.spacire.com">All Tools</a>
                <a href="https://spacire.com/collections/sleep-aids-for-better-rest">Sleep Products</a>
                <a href="https://spacire.com/blogs/journal">Sleep Journal</a>
                <a href="https://spacire.com">Shop</a>
            </nav>
            <button class="mobile-menu-btn" aria-label="Toggle menu" onclick="toggleMobileMenu()">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
        <nav class="mobile-nav" id="mobileNav">
            <a href="https://tools.spacire.com">All Tools</a>
            <a href="https://spacire.com/collections/sleep-aids-for-better-rest">Sleep Products</a>
            <a href="https://spacire.com/blogs/journal">Sleep Journal</a>
            <a href="https://spacire.com">Shop</a>
        </nav>
    </header>
    
    <!-- Breadcrumb -->
    <nav class="breadcrumb" aria-label="Breadcrumb">
        <div class="breadcrumb-content">
            <a href="https://spacire.com">Spacire</a>
            <span>&gt;</span>
            <a href="https://tools.spacire.com">Sleep Tools</a>
            <span>&gt;</span>
            <span style="color: var(--text-primary);">Caffeine Sleep Calculator</span>
        </div>
    </nav>
    
    <main class="main-container">
        <header class="page-title">
            <h1>Caffeine Sleep Calculator</h1>
            <p class="page-subtitle">Find your ideal caffeine cutoff time based on your metabolism. See how your coffee intake affects your sleep quality.</p>
        </header>
        
        <!-- Calculator Card -->
        <div class="tool-card" id="calculatorCard">
            <div class="tool-header">
                <h2>Calculate Your Caffeine Cutoff</h2>
                <p>Based on caffeine half-life and your personal metabolism</p>
            </div>
            
            <div class="tool-body">
                <!-- Bedtime -->
                <div class="form-section">
                    <label class="form-label">What time do you go to bed?</label>
                    <input type="time" class="time-input" id="bedtime" value="22:30">
                </div>
                
                <!-- Drinks Section -->
                <div class="drink-section">
                    <div class="drink-section-title">Add Your Caffeine Drinks</div>
                    
                    <div class="drink-grid">
                        <button class="drink-btn" onclick="quickAddDrink('Espresso', 63)">
                            <span class="drink-name">Espresso</span>
                            <span class="drink-mg">63 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Drip Coffee', 95)">
                            <span class="drink-name">Drip Coffee</span>
                            <span class="drink-mg">95 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Double Espresso', 126)">
                            <span class="drink-name">Double Espresso</span>
                            <span class="drink-mg">126 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Cold Brew', 200)">
                            <span class="drink-name">Cold Brew</span>
                            <span class="drink-mg">200 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Black Tea', 47)">
                            <span class="drink-name">Black Tea</span>
                            <span class="drink-mg">47 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Green Tea', 28)">
                            <span class="drink-name">Green Tea</span>
                            <span class="drink-mg">28 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Energy Drink', 80)">
                            <span class="drink-name">Energy Drink</span>
                            <span class="drink-mg">80 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Cola', 34)">
                            <span class="drink-name">Cola</span>
                            <span class="drink-mg">34 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Dark Chocolate', 23)">
                            <span class="drink-name">Dark Chocolate</span>
                            <span class="drink-mg">23 mg (1oz)</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Matcha', 70)">
                            <span class="drink-name">Matcha</span>
                            <span class="drink-mg">70 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Latte', 75)">
                            <span class="drink-name">Latte</span>
                            <span class="drink-mg">75 mg</span>
                        </button>
                        <button class="drink-btn" onclick="quickAddDrink('Decaf Coffee', 5)">
                            <span class="drink-name">Decaf Coffee</span>
                            <span class="drink-mg">5 mg</span>
                        </button>
                    </div>
                    
                    <div class="custom-drink">
                        <input type="text" id="customDrinkName" placeholder="Custom drink name">
                        <input type="number" id="customDrinkMg" placeholder="mg" min="1" max="500">
                        <input type="time" id="customDrinkTime" value="08:00">
                        <button class="add-drink-btn" onclick="addCustomDrink()">Add Drink</button>
                    </div>
                    
                    <div class="drinks-list" id="drinksList">
                        <div class="drinks-list-title">Your Drinks Today</div>
                        <div id="drinksContainer">
                            <div class="no-drinks">No drinks added yet. Click a drink above or add a custom one.</div>
                        </div>
                    </div>
                </div>
                
                <!-- Metabolism Factors -->
                <div class="form-section">
                    <label class="form-label">Metabolism Factors <span class="form-sublabel">(Select all that apply)</span></label>
                    <div class="factors-grid">
                        <label class="factor-item" onclick="toggleFactor(this)">
                            <input type="checkbox" class="factor-checkbox" value="pregnant" data-modifier="2.0">
                            <div>
                                <span class="factor-label">Pregnant</span>
                                <span class="factor-effect">2x slower metabolism</span>
                            </div>
                        </label>
                        <label class="factor-item" onclick="toggleFactor(this)">
                            <input type="checkbox" class="factor-checkbox" value="birth-control" data-modifier="1.5">
                            <div>
                                <span class="factor-label">Hormonal Birth Control</span>
                                <span class="factor-effect">1.5x slower metabolism</span>
                            </div>
                        </label>
                        <label class="factor-item" onclick="toggleFactor(this)">
                            <input type="checkbox" class="factor-checkbox" value="smoker" data-modifier="0.5">
                            <div>
                                <span class="factor-label">Smoker</span>
                                <span class="factor-effect">2x faster metabolism</span>
                            </div>
                        </label>
                        <label class="factor-item" onclick="toggleFactor(this)">
                            <input type="checkbox" class="factor-checkbox" value="liver-condition" data-modifier="2.0">
                            <div>
                                <span class="factor-label">Liver Condition</span>
                                <span class="factor-effect">2x slower metabolism</span>
                            </div>
                        </label>
                        <label class="factor-item" onclick="toggleFactor(this)">
                            <input type="checkbox" class="factor-checkbox" value="over-65" data-modifier="1.3">
                            <div>
                                <span class="factor-label">Over 65 Years</span>
                                <span class="factor-effect">1.3x slower metabolism</span>
                            </div>
                        </label>
                        <label class="factor-item" onclick="toggleFactor(this)">
                            <input type="checkbox" class="factor-checkbox" value="active" data-modifier="0.85">
                            <div>
                                <span class="factor-label">Regular Exercise</span>
                                <span class="factor-effect">Slightly faster metabolism</span>
                            </div>
                        </label>
                    </div>
                </div>
                
                <!-- Sensitivity -->
                <div class="form-section">
                    <label class="form-label">Caffeine Sensitivity</label>
                    <div class="sensitivity-container">
                        <input type="range" class="sensitivity-slider" id="sensitivitySlider" min="1" max="5" value="3" oninput="updateSensitivity()">
                        <div class="sensitivity-labels">
                            <span>Low (Can sleep easily)</span>
                            <span>High (Very sensitive)</span>
                        </div>
                        <div class="sensitivity-value" id="sensitivityValue">Moderate - Target: 50mg at bedtime</div>
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="calculateCaffeine()">Calculate My Cutoff Time</button>
            </div>
        </div>
        
        <!-- Results Section -->
        <div class="results-section" id="resultsSection">
            <!-- Main Result -->
            <div class="main-result" id="mainResult">
                <div class="result-label">Latest Safe Caffeine Time</div>
                <div class="result-time" id="resultTime">2:30 PM</div>
                <div class="result-details" id="resultDetails">Stop caffeine by this time for quality sleep</div>
                <div class="result-badge" id="resultBadge">Based on your metabolism</div>
            </div>
            
            <!-- Summary Cards -->
            <div class="summary-grid" id="summaryGrid">
                <div class="summary-card">
                    <div class="summary-value" id="totalCaffeine">0</div>
                    <div class="summary-label">Total Caffeine (mg)</div>
                </div>
                <div class="summary-card" id="bedtimeCaffeineCard">
                    <div class="summary-value" id="bedtimeCaffeine">0</div>
                    <div class="summary-label">At Bedtime (mg)</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="halfLife">5.0h</div>
                    <div class="summary-label">Your Half-Life</div>
                </div>
                <div class="summary-card">
                    <div class="summary-value" id="clearTime">--</div>
                    <div class="summary-label">Fully Clear By</div>
                </div>
            </div>
            
            <!-- Chart -->
            <div class="chart-section">
                <div class="chart-title">Your Caffeine Levels Throughout the Day</div>
                <div class="chart-container">
                    <canvas id="caffeineChart" class="chart-canvas"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="legend-item"><div class="legend-color" style="background: #6f4e37;"></div> Caffeine Level</div>
                    <div class="legend-item"><div class="legend-color" style="background: #dc3545;"></div> Bedtime</div>
                    <div class="legend-item"><div class="legend-color" style="background: #28a745; opacity: 0.3;"></div> Safe Zone</div>
                </div>
            </div>
            
            <!-- Sleep Impact -->
            <div class="sleep-impact">
                <div class="impact-title">Predicted Sleep Impact</div>
                <div class="impact-grid" id="impactGrid">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Recommendations -->
            <div class="recommendations">
                <div class="rec-title">Personalized Recommendations</div>
                <div id="recommendationsContainer">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Email Capture -->
            <div class="email-capture">
                <h3 class="email-capture-title">Save Your Caffeine Plan</h3>
                <p class="email-capture-text">Get your personalized cutoff time and recommendations sent to your inbox.</p>
                <form class="email-form" onsubmit="sendReport(event)">
                    <input type="text" class="email-input" id="userName" placeholder="First name" required>
                    <input type="email" class="email-input" id="userEmail" placeholder="Email address" required>
                    <button type="submit" class="btn btn-email" id="sendReportBtn">Send Report</button>
                </form>
                <p class="email-success" id="emailSuccess">Report sent! Check your inbox.</p>
                <p class="form-error" id="formError"></p>
            </div>
            
            <!-- Disclaimer -->
            <div class="disclaimer">
                <div class="disclaimer-title">Important Note</div>
                <p class="disclaimer-text">Caffeine metabolism varies significantly between individuals based on genetics, medications, and health conditions. These calculations are estimates based on average half-life data. Consult a healthcare provider for personalized advice, especially if pregnant or have health conditions.</p>
            </div>
            
            <button class="new-calc-btn" onclick="resetCalculator()">Calculate New Times</button>
        </div>
        
        <!-- Info Toggles -->
        <section class="info-section">
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">How It Works</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <h4>The Science of Caffeine Half-Life</h4>
                    <p>Caffeine has a "half-life" - the time it takes for your body to eliminate half of the caffeine. For most adults, this is about 5 hours, but it can range from 3-7 hours based on various factors.</p>
                    
                    <h4>Our Calculation Method</h4>
                    <ul>
                        <li><strong>Base half-life:</strong> We start with the average 5-hour half-life</li>
                        <li><strong>Metabolism factors:</strong> We adjust based on factors like pregnancy, smoking, age, and medications</li>
                        <li><strong>Sensitivity level:</strong> Your target bedtime caffeine level (25-75mg) based on sensitivity</li>
                        <li><strong>Drink stacking:</strong> We calculate cumulative caffeine from multiple drinks</li>
                    </ul>
                    
                    <h4>The Formula</h4>
                    <p>Remaining caffeine = Initial dose x 0.5^(hours elapsed / half-life)</p>
                    <p>For example, 100mg of caffeine with a 5-hour half-life leaves approximately 50mg after 5 hours, 25mg after 10 hours, and so on.</p>
                </div>
            </div>
            
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">Caffeine Content Guide</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <h4>Common Caffeine Sources</h4>
                    <table class="info-table">
                        <tr>
                            <th>Drink/Food</th>
                            <th>Serving Size</th>
                            <th>Caffeine (mg)</th>
                        </tr>
                        <tr><td>Espresso</td><td>1 shot (30ml)</td><td>63</td></tr>
                        <tr><td>Drip Coffee</td><td>8 oz (240ml)</td><td>95</td></tr>
                        <tr><td>Cold Brew</td><td>8 oz (240ml)</td><td>200</td></tr>
                        <tr><td>Instant Coffee</td><td>8 oz (240ml)</td><td>62</td></tr>
                        <tr><td>Black Tea</td><td>8 oz (240ml)</td><td>47</td></tr>
                        <tr><td>Green Tea</td><td>8 oz (240ml)</td><td>28</td></tr>
                        <tr><td>Matcha</td><td>1 tsp (2g)</td><td>70</td></tr>
                        <tr><td>Red Bull</td><td>8.4 oz (250ml)</td><td>80</td></tr>
                        <tr><td>Monster</td><td>16 oz (473ml)</td><td>160</td></tr>
                        <tr><td>Coca-Cola</td><td>12 oz (355ml)</td><td>34</td></tr>
                        <tr><td>Dark Chocolate</td><td>1 oz (28g)</td><td>23</td></tr>
                        <tr><td>Decaf Coffee</td><td>8 oz (240ml)</td><td>2-5</td></tr>
                    </table>
                    
                    <p><strong>Note:</strong> Caffeine content can vary significantly based on brand, brewing method, and serving size.</p>
                </div>
            </div>
            
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">Factors Affecting Caffeine Metabolism</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <h4>What Slows Down Caffeine Metabolism</h4>
                    <ul>
                        <li><strong>Pregnancy:</strong> Half-life can double or triple, especially in the third trimester</li>
                        <li><strong>Hormonal birth control:</strong> Oral contraceptives can increase half-life by 50%</li>
                        <li><strong>Liver conditions:</strong> Reduced liver function significantly slows caffeine processing</li>
                        <li><strong>Age:</strong> Older adults tend to metabolize caffeine more slowly</li>
                        <li><strong>CYP1A2 gene variants:</strong> "Slow metabolizers" can have half-lives of 8-10+ hours</li>
                    </ul>
                    
                    <h4>What Speeds Up Caffeine Metabolism</h4>
                    <ul>
                        <li><strong>Smoking:</strong> Induces CYP1A2 enzyme, nearly halving the half-life</li>
                        <li><strong>Regular exercise:</strong> May slightly increase metabolism rate</li>
                        <li><strong>Cruciferous vegetables:</strong> Broccoli, cauliflower may boost caffeine clearance</li>
                        <li><strong>CYP1A2 gene variants:</strong> "Fast metabolizers" may clear caffeine in 2-3 hours</li>
                    </ul>
                </div>
            </div>
            
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">About This Tool</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <h4>What Makes This Calculator Different</h4>
                    <ul>
                        <li><strong>Multiple metabolism factors:</strong> Account for pregnancy, medications, age, and lifestyle</li>
                        <li><strong>Drink stacking:</strong> Add multiple drinks and see cumulative effects</li>
                        <li><strong>Visual decay curve:</strong> See your caffeine levels throughout the day</li>
                        <li><strong>Sleep impact prediction:</strong> Understand how caffeine affects your sleep quality</li>
                        <li><strong>Personalized sensitivity:</strong> Adjust for your individual caffeine tolerance</li>
                    </ul>
                    
                    <h4>About Spacire</h4>
                    <p>Spacire is a UK-based sleep wellness company offering free science-backed tools and curated sleep products. We believe everyone deserves better sleep.</p>
                    <p><a href="https://spacire.com/pages/about-us" target="_blank" rel="noopener">Learn more about Spacire</a></p>
                </div>
            </div>
            
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">Share This Tool</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <h4>Help Others Sleep Better</h4>
                    <p>If you found this caffeine calculator helpful, share it with friends and family.</p>
                    
                    <div class="share-buttons">
                        <a href="https://twitter.com/intent/tweet?url=https://tools.spacire.com/caffeine-sleep-calculator&text=Caffeine%20Sleep%20Calculator%20-%20Find%20your%20ideal%20caffeine%20cutoff%20time" target="_blank" rel="noopener noreferrer" class="share-btn twitter">
                            <svg viewBox="0 0 24 24"><path d="M22.46,6C21.69,6.35 20.86,6.58 20,6.69C20.88,6.16 21.56,5.32 21.88,4.31C21.05,4.81 20.13,5.16 19.16,5.36C18.37,4.5 17.26,4 16,4C13.65,4 11.73,5.92 11.73,8.29C11.73,8.63 11.77,8.96 11.84,9.27C8.28,9.09 5.11,7.38 3,4.79C2.63,5.42 2.42,6.16 2.42,6.94C2.42,8.43 3.17,9.75 4.33,10.5C3.62,10.5 2.96,10.3 2.38,10C2.38,10 2.38,10 2.38,10.03C2.38,12.11 3.86,13.85 5.82,14.24C5.46,14.34 5.08,14.39 4.69,14.39C4.42,14.39 4.15,14.36 3.89,14.31C4.43,16 6,17.26 7.89,17.29C6.43,18.45 4.58,19.13 2.56,19.13C2.22,19.13 1.88,19.11 1.54,19.07C3.44,20.29 5.7,21 8.12,21C16,21 20.33,14.46 20.33,8.79C20.33,8.6 20.33,8.42 20.32,8.23C21.16,7.63 21.88,6.87 22.46,6Z"/></svg>
                            Share on X/Twitter
                        </a>
                        <a href="https://www.facebook.com/sharer/sharer.php?u=https://tools.spacire.com/caffeine-sleep-calculator" target="_blank" rel="noopener noreferrer" class="share-btn facebook">
                            <svg viewBox="0 0 24 24"><path d="M12 2.04C6.5 2.04 2 6.53 2 12.06C2 17.06 5.66 21.21 10.44 21.96V14.96H7.9V12.06H10.44V9.85C10.44 7.34 11.93 5.96 14.22 5.96C15.31 5.96 16.45 6.15 16.45 6.15V8.62H15.19C13.95 8.62 13.56 9.39 13.56 10.18V12.06H16.34L15.89 14.96H13.56V21.96A10 10 0 0 0 22 12.06C22 6.53 17.5 2.04 12 2.04Z"/></svg>
                            Share on Facebook
                        </a>
                        <button class="share-btn copy" onclick="copyLink()">
                            <svg viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"/></svg>
                            Copy Link
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="info-toggle">
                <div class="toggle-header" onclick="toggleInfo(this)">
                    <span class="toggle-title">More Sleep Tools</span>
                    <span class="toggle-icon">&#9660;</span>
                </div>
                <div class="info-content">
                    <h4>Continue Your Sleep Journey</h4>
                    <p>Explore these complementary tools:</p>
                    
                    <div class="tools-grid-info">
                        <a href="https://tools.spacire.com/sleep-calculator" class="tool-link-card">
                            <h5>Sleep Calculator</h5>
                            <p>Find ideal bedtime by age</p>
                        </a>
                        <a href="https://tools.spacire.com/sleep-quality-assessment" class="tool-link-card">
                            <h5>Sleep Quality Assessment</h5>
                            <p>7-dimension sleep analysis</p>
                        </a>
                        <a href="https://tools.spacire.com/chronotype-quiz" class="tool-link-card">
                            <h5>Chronotype Quiz</h5>
                            <p>Discover your sleep-wake rhythm</p>
                        </a>
                        <a href="https://tools.spacire.com/sleep-hygiene-quiz" class="tool-link-card">
                            <h5>Sleep Hygiene Quiz</h5>
                            <p>Assess your sleep habits</p>
                        </a>
                        <a href="https://tools.spacire.com/power-nap-calculator" class="tool-link-card">
                            <h5>Power Nap Calculator</h5>
                            <p>Optimal nap timing</p>
                        </a>
                        <a href="https://tools.spacire.com/insomnia-quiz" class="tool-link-card">
                            <h5>Insomnia Quiz</h5>
                            <p>Assess insomnia severity</p>
                        </a>
                    </div>
                    
                    <p style="margin-top: 20px; text-align: center;"><a href="https://tools.spacire.com" style="color: var(--primary); font-weight: 600;">View All 16 Sleep Tools</a></p>
                </div>
            </div>
        </section>
    </main>
    
    <!-- Footer -->
    <footer class="site-footer">
        <div class="footer-content">
            <div class="footer-grid">
                <div class="footer-section">
                    <h4>Sleep Tools</h4>
                    <a href="https://tools.spacire.com/caffeine-sleep-calculator">Caffeine Sleep Calculator</a>
                    <a href="https://tools.spacire.com/sleep-calculator">Sleep Calculator</a>
                    <a href="https://tools.spacire.com/chronotype-quiz">Chronotype Quiz</a>
                    <a href="https://tools.spacire.com/sleep-cycle-calculator">Sleep Cycle Calculator</a>
                    <a href="https://tools.spacire.com/insomnia-quiz">Insomnia Quiz</a>
                    <a href="https://tools.spacire.com/sleep-quality-assessment">Sleep Quality Assessment</a>
                </div>
                <div class="footer-section">
                    <h4>Shop</h4>
                    <a href="https://spacire.com/collections/sleep-masks">Sleep Masks</a>
                    <a href="https://spacire.com/collections/white-noise-machines">White Noise Machines</a>
                    <a href="https://spacire.com/collections/blackout-curtains">Blackout Curtains</a>
                    <a href="https://spacire.com/collections/pillow-sleep-sprays">Sleep Sprays</a>
                    <a href="https://spacire.com/collections/weighted-blankets">Weighted Blankets</a>
                </div>
                <div class="footer-section">
                    <h4>Company</h4>
                    <a href="https://spacire.com/pages/about-us">About Us</a>
                    <a href="https://spacire.com/pages/contact">Contact</a>
                    <a href="https://spacire.com/pages/faqs">FAQs</a>
                    <a href="https://spacire.com/blogs/journal">Sleep Journal</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 Spacire (The Valen Collective LTD). Company Registered in England &amp; Wales. Reg: 16695657. 167 Kennington Road, Nottingham, NG8 1QE, UK.</p>
                <div class="footer-legal">
                    <a href="https://spacire.com/policies/privacy-policy">Privacy Policy</a>
                    <a href="https://spacire.com/policies/terms-of-service">Terms of Service</a>
                    <a href="https://spacire.com/policies/refund-policy">Refunds</a>
                    <a href="https://spacire.com/policies/shipping-policy">Shipping</a>
                </div>
            </div>
        </div>
    </footer>
    
    <!-- Appwrite SDK -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@14.0.1"></script>
    
    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        const CONFIG = {
            endpoint: 'https://nyc.cloud.appwrite.io/v1',
            projectId: 'spacire-sleep-tools',
            databaseId: 'sleeptools_db',
            tableId: 'tool_submissions',
            functionId: 'send_sleep_report'
        };
        
        // Initialize Appwrite
        const client = new Appwrite.Client()
            .setEndpoint(CONFIG.endpoint)
            .setProject(CONFIG.projectId);
        
        const databases = new Appwrite.Databases(client);
        const functions = new Appwrite.Functions(client);
        
        // ========================================
        // STATE
        // ========================================
        let drinks = [];
        let calculatedResults = null;
        const BASE_HALF_LIFE = 5; // hours
        
        // Sensitivity levels (mg target at bedtime)
        const sensitivityLevels = {
            1: { target: 75, label: 'Low - Target: 75mg at bedtime' },
            2: { target: 60, label: 'Low-Moderate - Target: 60mg at bedtime' },
            3: { target: 50, label: 'Moderate - Target: 50mg at bedtime' },
            4: { target: 35, label: 'Moderate-High - Target: 35mg at bedtime' },
            5: { target: 25, label: 'High - Target: 25mg at bedtime' }
        };
        
        // ========================================
        // MOBILE MENU
        // ========================================
        function toggleMobileMenu() {
            document.getElementById('mobileNav').classList.toggle('active');
        }
        
        // ========================================
        // INFO TOGGLES
        // ========================================
        function toggleInfo(header) {
            const toggle = header.closest('.info-toggle');
            const content = toggle.querySelector('.info-content');
            toggle.classList.toggle('open');
            content.classList.toggle('open');
        }
        
        function copyLink() {
            navigator.clipboard.writeText('https://tools.spacire.com/caffeine-sleep-calculator').then(() => {
                const btn = event.target.closest('.share-btn');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"/></svg> Copied!';
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            });
        }
        
        // ========================================
        // SENSITIVITY SLIDER
        // ========================================
        function updateSensitivity() {
            const value = document.getElementById('sensitivitySlider').value;
            document.getElementById('sensitivityValue').textContent = sensitivityLevels[value].label;
        }
        
        // ========================================
        // FACTOR TOGGLE
        // ========================================
        function toggleFactor(element) {
            element.classList.toggle('selected');
        }
        
        // ========================================
        // DRINK MANAGEMENT
        // ========================================
        function quickAddDrink(name, mg) {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const time = `${hours}:${minutes}`;
            
            drinks.push({ name, mg, time });
            renderDrinks();
        }
        
        function addCustomDrink() {
            const name = document.getElementById('customDrinkName').value.trim();
            const mg = parseInt(document.getElementById('customDrinkMg').value);
            const time = document.getElementById('customDrinkTime').value;
            
            if (!name || !mg || !time) {
                alert('Please fill in all fields');
                return;
            }
            
            drinks.push({ name, mg, time });
            renderDrinks();
            
            // Clear inputs
            document.getElementById('customDrinkName').value = '';
            document.getElementById('customDrinkMg').value = '';
        }
        
        function removeDrink(index) {
            drinks.splice(index, 1);
            renderDrinks();
        }
        
        function renderDrinks() {
            const container = document.getElementById('drinksContainer');
            
            if (drinks.length === 0) {
                container.innerHTML = '<div class="no-drinks">No drinks added yet. Click a drink above or add a custom one.</div>';
                return;
            }
            
            // Sort by time
            const sortedDrinks = [...drinks].sort((a, b) => a.time.localeCompare(b.time));
            
            container.innerHTML = sortedDrinks.map((drink, idx) => {
                const originalIdx = drinks.indexOf(drink);
                return `
                    <div class="drink-item">
                        <div class="drink-item-info">
                            <span class="drink-item-time">${formatTime12(drink.time)}</span>
                            <span class="drink-item-name">${drink.name}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span class="drink-item-mg">${drink.mg} mg</span>
                            <button class="drink-remove" onclick="removeDrink(${originalIdx})">&#10005;</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // ========================================
        // TIME UTILITIES
        // ========================================
        function formatTime12(time24) {
            const [hours, minutes] = time24.split(':');
            const h = parseInt(hours);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${h12}:${minutes} ${ampm}`;
        }
        
        function timeToMinutes(time) {
            const [hours, minutes] = time.split(':').map(Number);
            return hours * 60 + minutes;
        }
        
        function minutesToTime(minutes) {
            while (minutes < 0) minutes += 1440;
            minutes = minutes % 1440;
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }
        
        // ========================================
        // CALCULATIONS
        // ========================================
        function getHalfLifeModifier() {
            let modifier = 1;
            document.querySelectorAll('.factor-checkbox:checked').forEach(checkbox => {
                modifier *= parseFloat(checkbox.dataset.modifier);
            });
            return modifier;
        }
        
        function calculateCaffeineAtTime(drinks, targetTime, halfLife) {
            const targetMinutes = timeToMinutes(targetTime);
            let totalCaffeine = 0;
            
            drinks.forEach(drink => {
                const drinkMinutes = timeToMinutes(drink.time);
                let elapsed = targetMinutes - drinkMinutes;
                
                // Handle overnight (if drink is after bedtime, consider it next day)
                if (elapsed < 0) elapsed += 1440;
                
                const hoursElapsed = elapsed / 60;
                const remaining = drink.mg * Math.pow(0.5, hoursElapsed / halfLife);
                totalCaffeine += remaining;
            });
            
            return totalCaffeine;
        }
        
        function findCutoffTime(drinks, bedtime, halfLife, targetMg) {
            if (drinks.length === 0) return null;
            
            // Sort drinks by time
            const sortedDrinks = [...drinks].sort((a, b) => a.time.localeCompare(b.time));
            const lastDrink = sortedDrinks[sortedDrinks.length - 1];
            
            // Calculate how long it takes for caffeine to drop to target
            // Using the last drink as reference
            const totalMg = drinks.reduce((sum, d) => sum + d.mg, 0);
            
            // Time needed for totalMg to decay to targetMg
            // targetMg = totalMg * 0.5^(t/halfLife)
            // t = halfLife * log2(totalMg/targetMg)
            const hoursNeeded = halfLife * Math.log2(totalMg / targetMg);
            
            // Cutoff time is bedtime minus hoursNeeded
            const bedtimeMinutes = timeToMinutes(bedtime);
            const cutoffMinutes = bedtimeMinutes - (hoursNeeded * 60);
            
            return minutesToTime(cutoffMinutes);
        }
        
        function calculateSleepImpact(caffeineAtBedtime, sensitivity) {
            const target = sensitivityLevels[sensitivity].target;
            const excess = Math.max(0, caffeineAtBedtime - target);
            
            // Sleep onset delay: ~10min per 50mg excess
            const sleepOnsetDelay = Math.round((excess / 50) * 10);
            
            // Sleep efficiency reduction: ~2% per 25mg excess
            const efficiencyReduction = Math.min(20, Math.round((excess / 25) * 2));
            const sleepEfficiency = Math.max(75, 95 - efficiencyReduction);
            
            // Deep sleep reduction: ~5% per 50mg excess
            const deepSleepReduction = Math.min(30, Math.round((excess / 50) * 5));
            
            // Quality rating
            let quality, qualityColor;
            if (caffeineAtBedtime <= target) {
                quality = 'Minimal Impact';
                qualityColor = '#28a745';
            } else if (caffeineAtBedtime <= target * 1.5) {
                quality = 'Mild Impact';
                qualityColor = '#ffc107';
            } else if (caffeineAtBedtime <= target * 2) {
                quality = 'Moderate Impact';
                qualityColor = '#fd7e14';
            } else {
                quality = 'Significant Impact';
                qualityColor = '#dc3545';
            }
            
            return {
                sleepOnsetDelay,
                sleepEfficiency,
                deepSleepReduction,
                quality,
                qualityColor
            };
        }
        
        function calculateCaffeine() {
            if (drinks.length === 0) {
                alert('Please add at least one drink');
                return;
            }
            
            const bedtime = document.getElementById('bedtime').value;
            const sensitivity = parseInt(document.getElementById('sensitivitySlider').value);
            const targetMg = sensitivityLevels[sensitivity].target;
            
            // Calculate half-life with modifiers
            const halfLifeModifier = getHalfLifeModifier();
            const adjustedHalfLife = BASE_HALF_LIFE * halfLifeModifier;
            
            // Calculate caffeine at bedtime
            const caffeineAtBedtime = calculateCaffeineAtTime(drinks, bedtime, adjustedHalfLife);
            
            // Total caffeine consumed
            const totalCaffeine = drinks.reduce((sum, d) => sum + d.mg, 0);
            
            // Find cutoff time
            const cutoffTime = findCutoffTime(drinks, bedtime, adjustedHalfLife, targetMg);
            
            // Calculate when caffeine is fully cleared (below 10mg)
            const hoursToClear = adjustedHalfLife * Math.log2(totalCaffeine / 10);
            const lastDrinkTime = [...drinks].sort((a, b) => b.time.localeCompare(a.time))[0].time;
            const lastDrinkMinutes = timeToMinutes(lastDrinkTime);
            const clearMinutes = lastDrinkMinutes + (hoursToClear * 60);
            const clearTime = minutesToTime(clearMinutes);
            
            // Sleep impact
            const sleepImpact = calculateSleepImpact(caffeineAtBedtime, sensitivity);
            
            calculatedResults = {
                bedtime,
                sensitivity,
                targetMg,
                halfLife: adjustedHalfLife,
                caffeineAtBedtime: Math.round(caffeineAtBedtime),
                totalCaffeine,
                cutoffTime,
                clearTime,
                sleepImpact,
                drinks: [...drinks]
            };
            
            renderResults();
            drawChart();
            saveResults();
        }
        
        // ========================================
        // RENDER RESULTS
        // ========================================
        function renderResults() {
            const r = calculatedResults;
            document.getElementById('resultsSection').classList.add('active');
            
            // Main result
            document.getElementById('resultTime').textContent = formatTime12(r.cutoffTime);
            
            const isOk = r.caffeineAtBedtime <= r.targetMg;
            document.getElementById('resultDetails').textContent = isOk 
                ? `Your current schedule looks good for sleep!`
                : `Stop caffeine by this time to reach ${r.targetMg}mg at bedtime`;
            document.getElementById('resultBadge').textContent = `Half-life: ${r.halfLife.toFixed(1)} hours`;
            
            // Summary cards
            document.getElementById('totalCaffeine').textContent = r.totalCaffeine;
            document.getElementById('bedtimeCaffeine').textContent = r.caffeineAtBedtime;
            document.getElementById('halfLife').textContent = `${r.halfLife.toFixed(1)}h`;
            document.getElementById('clearTime').textContent = formatTime12(r.clearTime);
            
            // Bedtime caffeine card styling
            const bedtimeCard = document.getElementById('bedtimeCaffeineCard');
            bedtimeCard.className = 'summary-card';
            if (r.caffeineAtBedtime <= r.targetMg) {
                bedtimeCard.classList.add('success');
            } else if (r.caffeineAtBedtime <= r.targetMg * 1.5) {
                bedtimeCard.classList.add('warning');
            } else {
                bedtimeCard.classList.add('danger');
            }
            
            // Sleep impact
            const impactHtml = `
                <div class="impact-item">
                    <div class="impact-item-title">Sleep Onset Delay</div>
                    <div class="impact-item-value">+${r.sleepImpact.sleepOnsetDelay} min</div>
                    <div class="impact-item-desc">Extra time to fall asleep</div>
                </div>
                <div class="impact-item">
                    <div class="impact-item-title">Sleep Efficiency</div>
                    <div class="impact-item-value">${r.sleepImpact.sleepEfficiency}%</div>
                    <div class="impact-bar"><div class="impact-fill" style="width: ${r.sleepImpact.sleepEfficiency}%; background: ${r.sleepImpact.sleepEfficiency >= 90 ? '#28a745' : r.sleepImpact.sleepEfficiency >= 80 ? '#ffc107' : '#dc3545'};"></div></div>
                </div>
                <div class="impact-item">
                    <div class="impact-item-title">Deep Sleep Impact</div>
                    <div class="impact-item-value">-${r.sleepImpact.deepSleepReduction}%</div>
                    <div class="impact-item-desc">Reduction in deep sleep</div>
                </div>
                <div class="impact-item">
                    <div class="impact-item-title">Overall Impact</div>
                    <div class="impact-item-value" style="color: ${r.sleepImpact.qualityColor};">${r.sleepImpact.quality}</div>
                    <div class="impact-item-desc">Based on ${r.caffeineAtBedtime}mg at bedtime</div>
                </div>
            `;
            document.getElementById('impactGrid').innerHTML = impactHtml;
            
            // Recommendations
            const recommendations = generateRecommendations(r);
            document.getElementById('recommendationsContainer').innerHTML = recommendations.map(rec => `
                <div class="rec-item">
                    <div class="rec-icon">${rec.icon}</div>
                    <div class="rec-content">
                        <div class="rec-item-title">${rec.title}</div>
                        <p class="rec-item-text">${rec.text}</p>
                    </div>
                </div>
            `).join('');
            
            // Scroll to results
            document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        function generateRecommendations(r) {
            const recs = [];
            
            if (r.caffeineAtBedtime > r.targetMg) {
                recs.push({
                    icon: '&#9200;',
                    title: 'Move Your Last Caffeine Earlier',
                    text: `Try to have your last caffeinated drink by ${formatTime12(r.cutoffTime)} to reach your target of ${r.targetMg}mg at bedtime.`
                });
            }
            
            if (r.totalCaffeine > 400) {
                recs.push({
                    icon: '&#9888;',
                    title: 'Consider Reducing Total Intake',
                    text: `You're consuming ${r.totalCaffeine}mg daily. Health guidelines suggest staying under 400mg for most adults.`
                });
            }
            
            if (r.halfLife > 6) {
                recs.push({
                    icon: '&#128300;',
                    title: 'Your Metabolism is Slower',
                    text: `Your factors indicate a ${r.halfLife.toFixed(1)}-hour half-life. Consider cutting off caffeine even earlier than typical recommendations.`
                });
            }
            
            recs.push({
                icon: '&#9749;',
                title: 'Try Decaf After Cutoff',
                text: `Switch to decaf coffee or herbal tea after ${formatTime12(r.cutoffTime)} to satisfy cravings without affecting sleep.`
            });
            
            recs.push({
                icon: '&#128167;',
                title: 'Stay Hydrated',
                text: 'Caffeine is a mild diuretic. Drink water throughout the day to stay hydrated and help your body process caffeine.'
            });
            
            return recs;
        }
        
        // ========================================
        // CHART
        // ========================================
        function drawChart() {
            const canvas = document.getElementById('caffeineChart');
            const ctx = canvas.getContext('2d');
            const r = calculatedResults;
            
            // Set canvas size
            canvas.width = canvas.parentElement.offsetWidth;
            canvas.height = 200;
            
            const padding = { top: 20, right: 20, bottom: 30, left: 50 };
            const chartWidth = canvas.width - padding.left - padding.right;
            const chartHeight = canvas.height - padding.top - padding.bottom;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Calculate data points (every 30 minutes from first drink to bedtime + 2 hours)
            const firstDrink = [...r.drinks].sort((a, b) => a.time.localeCompare(b.time))[0];
            const startMinutes = timeToMinutes(firstDrink.time) - 60;
            const bedtimeMinutes = timeToMinutes(r.bedtime);
            let endMinutes = bedtimeMinutes + 120;
            if (endMinutes < startMinutes) endMinutes += 1440;
            
            const dataPoints = [];
            for (let m = startMinutes; m <= endMinutes; m += 30) {
                const time = minutesToTime(m);
                const caffeine = calculateCaffeineAtTime(r.drinks, time, r.halfLife);
                dataPoints.push({ minutes: m, caffeine, time });
            }
            
            // Find max caffeine for scale
            const maxCaffeine = Math.max(...dataPoints.map(d => d.caffeine), r.targetMg * 1.5);
            
            // Draw safe zone
            const safeY = padding.top + chartHeight - (r.targetMg / maxCaffeine) * chartHeight;
            ctx.fillStyle = 'rgba(40, 167, 69, 0.1)';
            ctx.fillRect(padding.left, safeY, chartWidth, chartHeight - (safeY - padding.top));
            
            // Draw axes
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding.left, padding.top);
            ctx.lineTo(padding.left, padding.top + chartHeight);
            ctx.lineTo(padding.left + chartWidth, padding.top + chartHeight);
            ctx.stroke();
            
            // Draw caffeine curve
            ctx.strokeStyle = '#6f4e37';
            ctx.lineWidth = 3;
            ctx.beginPath();
            
            dataPoints.forEach((point, i) => {
                const x = padding.left + ((point.minutes - startMinutes) / (endMinutes - startMinutes)) * chartWidth;
                const y = padding.top + chartHeight - (point.caffeine / maxCaffeine) * chartHeight;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            });
            ctx.stroke();
            
            // Draw bedtime line
            const bedtimeX = padding.left + ((bedtimeMinutes - startMinutes) / (endMinutes - startMinutes)) * chartWidth;
            ctx.strokeStyle = '#dc3545';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]);
            ctx.beginPath();
            ctx.moveTo(bedtimeX, padding.top);
            ctx.lineTo(bedtimeX, padding.top + chartHeight);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw target line
            ctx.strokeStyle = '#28a745';
            ctx.lineWidth = 1;
            ctx.setLineDash([3, 3]);
            ctx.beginPath();
            ctx.moveTo(padding.left, safeY);
            ctx.lineTo(padding.left + chartWidth, safeY);
            ctx.stroke();
            ctx.setLineDash([]);
            
            // Draw bedtime caffeine point
            const bedtimeCaffeineY = padding.top + chartHeight - (r.caffeineAtBedtime / maxCaffeine) * chartHeight;
            ctx.fillStyle = r.caffeineAtBedtime <= r.targetMg ? '#28a745' : '#dc3545';
            ctx.beginPath();
            ctx.arc(bedtimeX, bedtimeCaffeineY, 6, 0, Math.PI * 2);
            ctx.fill();
            
            // Labels
            ctx.fillStyle = '#555';
            ctx.font = '11px Domine, Georgia, serif';
            ctx.textAlign = 'center';
            
            // Time labels
            const timeLabels = [startMinutes, startMinutes + (endMinutes - startMinutes) / 2, endMinutes];
            timeLabels.forEach(m => {
                const x = padding.left + ((m - startMinutes) / (endMinutes - startMinutes)) * chartWidth;
                ctx.fillText(formatTime12(minutesToTime(m)), x, canvas.height - 5);
            });
            
            // Y-axis labels
            ctx.textAlign = 'right';
            ctx.fillText(`${Math.round(maxCaffeine)}mg`, padding.left - 5, padding.top + 5);
            ctx.fillText(`${r.targetMg}mg`, padding.left - 5, safeY + 4);
            ctx.fillText('0mg', padding.left - 5, padding.top + chartHeight);
            
            // Bedtime label
            ctx.fillStyle = '#dc3545';
            ctx.textAlign = 'center';
            ctx.fillText('Bedtime', bedtimeX, padding.top - 5);
        }
        
        // ========================================
        // DATABASE & EMAIL
        // ========================================
        async function saveResults() {
            if (!calculatedResults) return;
            
            try {
                await databases.createDocument(
                    CONFIG.databaseId,
                    CONFIG.tableId,
                    'unique()',
                    {
                        tool_name: 'caffeine_sleep_calculator',
                        results_json: JSON.stringify({
                            cutoffTime: calculatedResults.cutoffTime,
                            caffeineAtBedtime: calculatedResults.caffeineAtBedtime,
                            totalCaffeine: calculatedResults.totalCaffeine,
                            halfLife: calculatedResults.halfLife
                        }),
                        user_agent: navigator.userAgent.substring(0, 500),
                        created_at: new Date().toISOString()
                    }
                );
            } catch (error) {
                console.error('DB error:', error);
            }
        }
        
        async function sendReport(event) {
            event.preventDefault();
            
            const email = document.getElementById('userEmail').value.trim();
            const firstName = document.getElementById('userName').value.trim();
            const sendBtn = document.getElementById('sendReportBtn');
            const formError = document.getElementById('formError');
            
            formError.style.display = 'none';
            
            if (!firstName || firstName.length < 1) {
                formError.textContent = 'Please enter your first name';
                formError.style.display = 'block';
                return;
            }
            
            const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
            if (!email || !emailPattern.test(email)) {
                formError.textContent = 'Please enter a valid email address';
                formError.style.display = 'block';
                return;
            }
            
            if (!calculatedResults) {
                formError.textContent = 'Please calculate your caffeine cutoff first.';
                formError.style.display = 'block';
                return;
            }
            
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = 'Sending...';
            sendBtn.disabled = true;
            
            const r = calculatedResults;
            const emailPayload = JSON.stringify({
                toolName: 'caffeine-sleep-calculator',
                email: email,
                firstName: firstName,
                cutoffTime: formatTime12(r.cutoffTime),
                bedtime: formatTime12(r.bedtime),
                caffeineAtBedtime: r.caffeineAtBedtime,
                totalCaffeine: r.totalCaffeine,
                halfLife: r.halfLife,
                targetMg: r.targetMg,
                sleepImpact: r.sleepImpact,
                drinks: r.drinks.map(d => ({ name: d.name, mg: d.mg, time: formatTime12(d.time) }))
            });
            
            try {
                try {
                    await databases.createDocument(
                        CONFIG.databaseId,
                        CONFIG.tableId,
                        'unique()',
                        {
                            tool_name: 'caffeine_sleep_calculator',
                            user_email: email,
                            user_first_name: firstName,
                            results_json: JSON.stringify({
                                cutoffTime: r.cutoffTime,
                                caffeineAtBedtime: r.caffeineAtBedtime,
                                emailSent: true
                            }),
                            user_agent: navigator.userAgent.substring(0, 500),
                            created_at: new Date().toISOString()
                        }
                    );
                } catch (dbError) {
                    console.error('DB error:', dbError);
                }
                
                await functions.createExecution(
                    CONFIG.functionId,
                    emailPayload,
                    true
                );
                
                document.getElementById('emailSuccess').style.display = 'block';
                document.getElementById('userEmail').disabled = true;
                document.getElementById('userName').disabled = true;
                sendBtn.style.display = 'none';
                
            } catch (error) {
                console.error('Email error:', error);
                formError.textContent = 'Failed to send. Please try again.';
                formError.style.display = 'block';
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
            }
        }
        
        function resetCalculator() {
            calculatedResults = null;
            drinks = [];
            renderDrinks();
            
            document.getElementById('userEmail').disabled = false;
            document.getElementById('userName').disabled = false;
            document.getElementById('userEmail').value = '';
            document.getElementById('userName').value = '';
            document.getElementById('sendReportBtn').style.display = 'inline-block';
            document.getElementById('sendReportBtn').disabled = false;
            document.getElementById('sendReportBtn').textContent = 'Send Report';
            document.getElementById('emailSuccess').style.display = 'none';
            document.getElementById('formError').style.display = 'none';
            
            // Reset factors
            document.querySelectorAll('.factor-item.selected').forEach(el => el.classList.remove('selected'));
            document.querySelectorAll('.factor-checkbox').forEach(el => el.checked = false);
            
            document.getElementById('resultsSection').classList.remove('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Initialize
        updateSensitivity();
    </script>
</body>
</html>
